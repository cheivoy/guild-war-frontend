    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 30px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header h1 {
        color: white;
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .nav-tabs {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .nav-tab {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .nav-tab:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    .nav-tab.active {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .tab-content {
        display: none;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .login-container {
        max-width: 400px;
        margin: 0 auto;
        text-align: center;
    }

    .discord-login {
        background: #5865F2;
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        font-size: 1.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        margin: 20px 0;
    }

    .discord-login:hover {
        background: #4752C4;
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(88, 101, 242, 0.3);
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
        transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        transition: all 0.3s ease;
        margin: 5px;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-danger {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    }

    .btn-success {
        background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
    }

    .registration-card {
        background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        border: 2px solid #e0e7ff;
        text-align: center;
    }

    .registration-status {
        font-size: 1.2em;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .status-registered {
        color: #10b981;
    }

    .status-not-registered {
        color: #6b7280;
    }

    .admin-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #667eea;
    }

    .job-button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 20px 0;
    }

    .job-button {
        background: #e0e7ff;
        border: 2px solid #667eea;
        border-radius: 8px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
    }

    .job-button:hover {
        background: #667eea;
        color: white;
    }

    .job-members {
        display: none;
        margin-top: 10px;
        padding: 10px;
        background: #f0f4ff;
        border-radius: 8px;
    }

    .job-members.active {
        display: block;
    }

    .member-id {
        display: inline-block;
        font-size: 0.8em;
        color: #666;
        margin: 5px;
        cursor: pointer;
    }

    .member-id:hover {
        color: #667eea;
        text-decoration: underline;
    }

    .battle-formation {
        margin: 20px 0;
        max-width: 100%;
        overflow-x: auto;
    }

    .team-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .team-table th,
    .team-table td {
        border: 1px solid #e0e0e0;
        padding: 12px;
        text-align: center;
        font-size: 0.9em;
    }

    .team-table th {
        background: #667eea;
        color: white;
        font-weight: 600;
    }

    .team-table td select {
        width: 100%;
        padding: 8px;
        border: none;
        border-radius: 4px;
        background: #f8f9fa;
    }

    .team-table td select:disabled {
        background: #e8f5e8;
        color: #333;
    }

    .team-table.readonly td {
        background: #f0f4ff;
    }

    .calendar-container {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        margin: 20px 0;
    }

    .calendar-day {
        aspect-ratio: 1;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }

    .calendar-day:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .calendar-day.selected {
        background: #667eea;
        color: white;
    }

    .calendar-day.has-event {
        background: #e8f5e8;
        border-color: #51cf66;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .stats-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        border: 2px solid #e0e0e0;
        text-align: center;
    }

    .stats-number {
        font-size: 2em;
        font-weight: 600;
        color: #667eea;
        margin-bottom: 10px;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        backdrop-filter: blur(5px);
    }

    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .close-modal {
        position: absolute;
        top: 15px;
        right: 20px;
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        color: #999;
    }

    .close-modal:hover {
        color: #333;
    }

    .user-info {
        background: #f0f4ff;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 10px;
        color: white;
        font-weight: 500;
        z-index: 1001;
        animation: slideIn 0.3s ease-out;
    }

    .notification.success {
        background: #10b981;
    }

    .notification.error {
        background: #ef4444;
    }

    .notification.info {
        background: #3b82f6;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @media (max-width: 768px) {
        .container {
            padding: 10px;
        }

        .team-table {
            font-size: 0.8em;
        }

        .team-table th,
        .team-table td {
            padding: 8px;
        }

        .nav-tabs {
            flex-direction: column;
            align-items: center;
        }

        .nav-tab {
            width: 200px;
        }

        .job-button-group {
            flex-direction: column;
            align-items: stretch;
        }

        .job-button {
            width: 100%;
            text-align: center;
        }
    }
</style>

    <!-- ç™»å…¥é é¢ -->
    <div id="loginPage" class="tab-content active">
        <div class="login-container">
            <h2>æ­¡è¿ä½¿ç”¨å¹«æˆ°å ±åç³»çµ±</h2>
            <p>è«‹ä½¿ç”¨Discordå¸³è™Ÿç™»å…¥ä»¥ç¢ºä¿èº«ä»½é©—è­‰</p>
            <div class="form-group">
                <label>æ¸¬è©¦æ¨¡å¼ï¼šé¸æ“‡ç”¨æˆ¶é¡å‹</label>
                <select id="loginTypeSelect">
                    <option value="user">æ™®é€šç”¨æˆ¶</option>
                    <option value="admin">ç®¡ç†å“¡</option>
                </select>
            </div>
            <button onclick="discordLogin()" class="discord-login">
                ğŸ® ä½¿ç”¨Discordç™»å…¥
            </button>
            <div id="newUserForm" style="display: none; margin-top: 30px;">
                <h3>é¦–æ¬¡ç™»å…¥è¨­å®š</h3>
                <div class="form-group">
                    <label>éŠæˆ²ID:</label>
                    <input type="text" id="gameId" placeholder="è«‹è¼¸å…¥æ‚¨çš„éŠæˆ²ID">
                </div>
                <div class="form-group">
                    <label>è·æ¥­:</label>
                    <select id="jobSelect">
                        <option value="">è«‹é¸æ“‡è·æ¥­</option>
                        <option value="ç´ å•">ç´ å•</option>
                        <option value="è¡€æ²³">è¡€æ²³</option>
                        <option value="ä¹éˆ">ä¹éˆ</option>
                        <option value="é¾åŸ">é¾åŸ</option>
                        <option value="ç¢å¤¢">ç¢å¤¢</option>
                        <option value="ç¥ç›¸">ç¥ç›¸</option>
                        <option value="éµè¡£">éµè¡£</option>
                    </select>
                </div>
                <button onclick="completeRegistration()" class="btn">å®Œæˆè¨»å†Š</button>
            </div>
        </div>
    </div>

    <!-- å°èˆªæ¨™ç±¤ -->
    <div id="mainNav" class="nav-tabs" style="display: none;">
        <button class="nav-tab active" onclick="showTab('home')">é¦–é </button>
        <button class="nav-tab" onclick="showTab('applications')">ç”³è«‹å°ˆå€</button>
        <button class="nav-tab" onclick="showTab('records')">å‡ºå‹¤ç´€éŒ„</button>
        <button id="adminTab" class="nav-tab" onclick="showTab('admin')" style="display: none;">ç®¡ç†å“¡</button>
    </div>

    <!-- é¦–é  -->
    <div id="home" class="tab-content">
        <div class="registration-card">
            <h2>ğŸ“… å¹«æˆ°å ±åç‹€æ…‹</h2>
            <div id="registrationStatus" class="registration-status status-not-registered">
                ç›®å‰æ²’æœ‰é–‹æ”¾çš„å¹«æˆ°å ±å
            </div>
            <div id="registrationDate" style="font-size: 1.1em; margin-bottom: 10px;"></div>
            <div id="registrationDeadline" style="font-size: 1em; margin-bottom: 10px;"></div>
            <div id="teamAssignment" style="font-size: 1em; margin-bottom: 10px;"></div>
            <div id="registrationActions">
                <button id="registerBtn" onclick="registerForBattle()" class="btn"
                    style="display: none;">å ±ååƒæˆ°</button>
                <button id="cancelBtn" onclick="cancelRegistration()" class="btn btn-danger"
                    style="display: none;">å–æ¶ˆå ±å</button>
                <div id="deadlineMessage" style="color: #ef4444; margin-top: 10px; display: none;">
                    å¦‚éœ€è¦æ›´å‹•ï¼Œè«‹ç›´æ¥DCè¯çµ¡æŒ‡æ®
                </div>
            </div>
        </div>

        <div id="battleFormation" style="display: none;">
            <h3>ğŸ“‹ å‡ºæˆ°è¡¨</h3>
            <div id="formationDisplay"></div>
        </div>
    </div>

    <!-- ç”³è«‹å°ˆå€ -->
    <div id="applications" class="tab-content">
        <div class="admin-section">
            <h3>ğŸ”„ æ›´æ›è·æ¥­ç”³è«‹</h3>
            <div class="form-group">
                <label>æ–°è·æ¥­:</label>
                <select id="newJobSelect">
                    <option value="">è«‹é¸æ“‡æ–°è·æ¥­</option>
                    <option value="ç´ å•">ç´ å•</option>
                    <option value="è¡€æ²³">è¡€æ²³</option>
                    <option value="ä¹éˆ">ä¹éˆ</option>
                    <option value="é¾åŸ">é¾åŸ</option>
                    <option value="ç¢å¤¢">ç¢å¤¢</option>
                    <option value="ç¥ç›¸">ç¥ç›¸</option>
                    <option value="éµè¡£">éµè¡£</option>
                </select>
            </div>
            <div class="form-group">
                <label>ç”³è«‹ç†ç”±:</label>
                <textarea id="jobChangeReason" placeholder="è«‹èªªæ˜æ›´æ›è·æ¥­çš„åŸå› " rows="3"></textarea>
            </div>
            <button onclick="submitJobChange()" class="btn">æäº¤ç”³è«‹</button>
        </div>

        <div class="admin-section">
            <h3>ğŸ‘¥ ä»£å ±åç³»çµ±</h3>
            <div class="form-group">
                <label>ä»£å ±åID:</label>
                <input type="text" id="proxyId" placeholder="è«‹è¼¸å…¥è¦ä»£å ±åçš„éŠæˆ²ID">
            </div>
            <div class="form-group">
                <label>ä»£å ±ååŸå› :</label>
                <textarea id="proxyReason" placeholder="è«‹èªªæ˜ä»£å ±åçš„åŸå› " rows="3"></textarea>
            </div>
            <button onclick="submitProxyRegistration()" class="btn">æäº¤ä»£å ±å</button>
        </div>

        <div class="admin-section">
            <h3>ğŸ¥ è«‹å‡ç”³è«‹</h3>
            <div class="form-group">
                <label>è«‹å‡æ—¥æœŸ:</label>
                <input type="date" id="leaveDate">
            </div>
            <div class="form-group">
                <label>è«‹å‡åŸå› ï¼ˆå¯ç©ºç™½ï¼‰:</label>
                <textarea id="leaveReason" placeholder="è«‹èªªæ˜è«‹å‡åŸå› " rows="3"></textarea>
            </div>
            <button id="leaveSubmitBtn" onclick="submitLeaveRequest()" class="btn">æäº¤è«‹å‡ç”³è«‹</button>
            <div id="leaveDeadlineMessage" style="color: #ef4444; margin-top: 10px; display: none;">
                å¦‚éœ€è¦è«‹å‡ï¼Œè«‹ç›´æ¥DCè¯çµ¡æŒ‡æ®
            </div>
        </div>
    </div>

    <!-- å‡ºå‹¤ç´€éŒ„ -->
    <div id="records" class="tab-content">
        <h2>ğŸ“Š æˆ‘çš„å‡ºå‹¤ç´€éŒ„</h2>
        <div class="stats-grid">
            <div class="stats-card">
                <div class="stats-number" id="attendanceRate">0%</div>
                <div>å‡ºå‹¤ç‡</div>
            </div>
            <div class="stats-card">
                <div class="stats-number" id="totalBattles">0</div>
                <div>ç¸½åƒæˆ°æ¬¡æ•¸</div>
            </div>
            <div class="stats-card">
                <div class="stats-number" id="absenceCount">0</div>
                <div>ç¼ºå¸­æ¬¡æ•¸</div>
            </div>
        </div>
        <div id="recordsList"></div>
    </div>

    <!-- ç®¡ç†å“¡é¢æ¿ -->
    <div id="admin" class="tab-content">
        <div class="admin-section">
            <h3>ğŸ“… é–‹æ”¾å ±åæ—¥æœŸ</h3>
            <div class="form-group">
                <label>å¹«æˆ°æ—¥æœŸ:</label>
                <input type="date" id="battleDate">
            </div>
            <div class="form-group">
                <label>å¹«æˆ°æ™‚é–“:</label>
                <select id="battleTime">
                    <option value="14:00">14:00</option>
                    <option value="20:00">20:00</option>
                </select>
            </div>
            <div class="form-group">
                <label>å ±åæˆªæ­¢æ—¥æœŸ:</label>
                <input type="date" id="deadlineDate">
            </div>
            <div class="form-group">
                <label>å ±åæˆªæ­¢æ™‚é–“:</label>
                <select id="deadlineTime">
                    <option value="12:00">12:00</option>
                    <option value="18:00">18:00</option>
                    <option value="20:00">20:00</option>
                    <option value="23:59">23:59</option>
                </select>
            </div>
            <button onclick="openRegistration()" class="btn">é–‹æ”¾å ±å</button>
            <button onclick="closeRegistration()" class="btn btn-danger">é—œé–‰å ±å</button>
        </div>

        <div class="admin-section">
            <h3>ğŸ‘¥ æˆå“¡ç®¡ç†</h3>
            <div class="job-button-group" id="jobButtonGroup"></div>
        </div>

        <div class="admin-section">
            <h3>âš”ï¸ å‡ºæˆ°è¡¨éƒ¨ç½²</h3>
            <div class="form-group">
                <button onclick="showFormationEditor('edit')" class="btn">ç·¨è¼¯å‡ºæˆ°è¡¨</button>
                <button onclick="publishFormation()" class="btn btn-success">ç™¼ä½ˆå‡ºæˆ°è¡¨</button>
                <button onclick="showFormationEditor('confirm')" class="btn btn-success">ç¢ºèªæœ€çµ‚å‡ºæˆ°è¡¨</button>
            </div>
            <div id="formationEditor" style="display: none;">
                <div class="battle-formation" id="battleFormation"></div>
                <div id="formationActions" style="text-align: center; margin-top: 20px;">
                    <button id="confirmFormationBtn" onclick="confirmFinalFormation()" class="btn btn-success" style="display: none;">ç¢ºèªæœ€çµ‚å‡ºæˆ°è¡¨</button>
                </div>
            </div>
        </div>

        <div class="admin-section">
            <h3>ğŸ“Š çµ±è¨ˆå ±è¡¨</h3>
            <div class="stats-grid">
                <div class="stats-card">
                    <div class="stats-number" id="totalMembers">0</div>
                    <div>ç¸½æˆå“¡æ•¸</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="registeredCount">0</div>
                    <div>å·²å ±åäººæ•¸</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="onLeaveCount">0</div>
                    <div>è«‹å‡äººæ•¸</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ¨¡æ…‹æ¡† -->
<div id="modal" class="modal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal()">Ã—</button>
        <div id="modalContent"></div>
    </div>
</div>

<script>
    // ç³»çµ±ç‹€æ…‹
    let currentUser = null;
    let isLoggedIn = false;
    let currentBattle = null;
    let battles = [];
    let members = [];
    let battleFormation = [];
    let registrations = [];
    let leaveRequests = [];
    let attendanceRecords = [];

    // åˆå§‹åŒ–æˆå“¡æ•¸æ“š
    const initialMembers = [
        { id: 'player001', discordId: 'admin_user1', name: 'å‹‡è€…', job: 'ç´ å•', isAdmin: true, onLeave: false },
        { id: 'player002', discordId: 'user2', name: 'æ³•å¸«', job: 'è¡€æ²³', isAdmin: false, onLeave: false },
        { id: 'player003', discordId: 'user3', name: 'å¼“æ‰‹', job: 'ä¹éˆ', isAdmin: false, onLeave: false },
        { id: 'player004', discordId: 'user4', name: 'ç‰§å¸«', job: 'é¾åŸ', isAdmin: false, onLeave: false },
        { id: 'player005', discordId: 'user5', name: 'ç›œè³Š', job: 'ç¢å¤¢', isAdmin: false, onLeave: false },
        { id: 'player006', discordId: 'user6', name: 'é¨å£«', job: 'ç¥ç›¸', isAdmin: false, onLeave: false },
        { id: 'player007', discordId: 'user7', name: 'æˆ°å£«', job: 'éµè¡£', isAdmin: false, onLeave: false }
    ];

    // è·æ¥­åˆ—è¡¨
    const jobs = ['ç´ å•', 'è¡€æ²³', 'ä¹éˆ', 'é¾åŸ', 'ç¢å¤¢', 'ç¥ç›¸', 'éµè¡£'];

    // åœ˜éšŠåç¨±
    const teamNames = ['é€²æ”»éšŠ', 'é˜²å®ˆéšŠ', 'æ©Ÿå‹•éšŠ', 'ç©ºæ‹†éšŠ', 'æ‹†å¡”éšŠ'];

    // åˆå§‹åŒ–ç³»çµ±
    function initSystem() {
        members = [...initialMembers];
        updateJobButtonGroup();
        updateStats();
    }

    // Discordç™»å…¥æ¨¡æ“¬
    function discordLogin() {
        showNotification('æ­£åœ¨é€£æ¥Discord...', 'info');
        setTimeout(() => {
            const loginType = document.getElementById('loginTypeSelect').value;
            let mockDiscordUser;
            if (loginType === 'admin') {
                mockDiscordUser = {
                    id: 'admin_user1',
                    username: 'AdminUser',
                    avatar: null
                };
            } else {
                mockDiscordUser = {
                    id: 'discord_' + Math.random().toString(36).substr(2, 9),
                    username: 'TestUser' + Math.floor(Math.random() * 1000),
                    avatar: null
                };
            }
            const existingUser = members.find(m => m.discordId === mockDiscordUser.id);
            if (existingUser) {
                currentUser = existingUser;
                completeLogin();
            } else {
                showNotification('Discordæˆæ¬ŠæˆåŠŸï¼è«‹å®Œæˆé¦–æ¬¡è¨­å®š', 'success');
                document.getElementById('newUserForm').style.display = 'block';
                currentUser = { discordId: mockDiscordUser.id, discordUsername: mockDiscordUser.username };
            }
        }, 2000);
    }

    // å®Œæˆè¨»å†Š
    function completeRegistration() {
        const gameId = document.getElementById('gameId').value.trim();
        const job = document.getElementById('jobSelect').value;
        const loginType = document.getElementById('loginTypeSelect').value;
        if (!gameId || !job) {
            showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦è³‡è¨Š', 'error');
            return;
        }
        if (members.find(m => m.id === gameId)) {
            showNotification('æ­¤éŠæˆ²IDå·²å­˜åœ¨', 'error');
            return;
        }
        const newUser = {
            id: gameId,
            discordId: currentUser.discordId,
            name: gameId,
            job: job,
            isAdmin: loginType === 'admin',
            onLeave: false
        };
        members.push(newUser);
        currentUser = newUser;
        showNotification('è¨»å†ŠæˆåŠŸï¼', 'success');
        completeLogin();
    }

    // å®Œæˆç™»å…¥
    function completeLogin() {
        isLoggedIn = true;
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainNav').style.display = 'flex';
        document.getElementById('userInfo').style.display = 'block';
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userJob').textContent = currentUser.job;
        if (currentUser.isAdmin) {
            document.getElementById('adminTab').style.display = 'block';
        }
        showTab('home');
        updateUserInterface();
    }

    // ç™»å‡º
    function logout() {
        currentUser = null;
        isLoggedIn = false;
        document.getElementById('loginPage').style.display = 'block';
        document.getElementById('mainNav').style.display = 'none';
        document.getElementById('userInfo').style.display = 'none';
        document.getElementById('adminTab').style.display = 'none';
        document.getElementById('newUserForm').style.display = 'none';
        document.getElementById('gameId').value = '';
        document.getElementById('jobSelect').value = '';
        document.getElementById('loginTypeSelect').value = 'user';
        showNotification('å·²æˆåŠŸç™»å‡º', 'info');
    }

    // é¡¯ç¤ºæ¨™ç±¤
    function showTab(tabName) {
        const tabs = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => tab.classList.remove('active'));
        const navTabs = document.querySelectorAll('.nav-tab');
        navTabs.forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
        switch (tabName) {
            case 'home':
                updateHomeContent();
                break;
            case 'records':
                updateRecordsContent();
                break;
            case 'admin':
                updateAdminContent();
                break;
        }
    }

    // æ›´æ–°ç”¨æˆ¶ç•Œé¢
    function updateUserInterface() {
        updateHomeContent();
        updateJobButtonGroup();
        updateStats();
    }

    // æª¢æŸ¥å ±åæˆªæ­¢æ™‚é–“
    function isPastDeadline(battle) {
        if (!battle.deadlineDate || !battle.deadlineTime) return false;
        const deadline = new Date(`${battle.deadlineDate}T${battle.deadlineTime}:00`);
        return new Date() > deadline;
    }

    // æ›´æ–°é¦–é å…§å®¹
    function updateHomeContent() {
        const statusDiv = document.getElementById('registrationStatus');
        const dateDiv = document.getElementById('registrationDate');
        const deadlineDiv = document.getElementById('registrationDeadline');
        const teamAssignmentDiv = document.getElementById('teamAssignment');
        const actionsDiv = document.getElementById('registrationActions');
        const registerBtn = document.getElementById('registerBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const deadlineMessage = document.getElementById('deadlineMessage');

        if (currentBattle) {
            const userRegistered = registrations.find(r => r.userId === currentUser.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time);
            if (userRegistered) {
                statusDiv.textContent = `âœ… ${currentBattle.date} ${currentBattle.time} å·²å ±å${userRegistered.isBackup ? 'ï¼ˆå‚™é¸åå–®ï¼‰' : ''}`;
                statusDiv.className = 'registration-status status-registered';
                registerBtn.style.display = 'none';
                cancelBtn.style.display = isPastDeadline(currentBattle) ? 'none' : 'inline-block';
            } else {
                statusDiv.textContent = `ğŸ“¢ ${currentBattle.date} ${currentBattle.time} é–‹æ”¾å ±åä¸­`;
                statusDiv.className = 'registration-status status-not-registered';
                registerBtn.style.display = 'inline-block';
                cancelBtn.style.display = 'none';
            }
            dateDiv.textContent = `å¹«æˆ°æ™‚é–“: ${currentBattle.date} ${currentBattle.time}`;
            deadlineDiv.textContent = currentBattle.deadlineDate ? `å ±åæˆªæ­¢: ${currentBattle.deadlineDate} ${currentBattle.deadlineTime}` : '';
            
            // é¡¯ç¤ºç”¨æˆ¶æ‰€åœ¨å°éšŠ
            if (currentBattle.formationPublished && currentBattle.formation) {
                let assignedTeam = null;
                currentBattle.formation.forEach((group, groupIndex) => {
                    group.forEach(team => {
                        if (team.slots.some(slot => slot.playerId === currentUser.id)) {
                            assignedTeam = `æ‚¨è¢«åˆ†é…åˆ°ç¬¬${groupIndex + 1}åœ˜ ${team.team}`;
                        }
                    });
                });
                teamAssignmentDiv.textContent = assignedTeam || 'æ‚¨å°šæœªè¢«åˆ†é…åˆ°ä»»ä½•å°éšŠ';
            } else {
                teamAssignmentDiv.textContent = '';
            }

            if (isPastDeadline(currentBattle)) {
                deadlineMessage.style.display = 'block';
                document.getElementById('leaveDeadlineMessage').style.display = 'block';
                document.getElementById('leaveSubmitBtn').style.display = 'none';
            } else {
                deadlineMessage.style.display = 'none';
                document.getElementById('leaveDeadlineMessage').style.display = 'none';
                document.getElementById('leaveSubmitBtn').style.display = 'inline-block';
            }
        } else {
            statusDiv.textContent = 'ç›®å‰æ²’æœ‰é–‹æ”¾çš„å¹«æˆ°å ±å';
            statusDiv.className = 'registration-status status-not-registered';
            dateDiv.textContent = '';
            deadlineDiv.textContent = '';
            teamAssignmentDiv.textContent = '';
            registerBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            deadlineMessage.style.display = 'none';
            document.getElementById('leaveDeadlineMessage').style.display = 'none';
            document.getElementById('leaveSubmitBtn').style.display = 'inline-block';
        }

        if (currentBattle && currentBattle.formationPublished) {
            document.getElementById('battleFormation').style.display = 'block';
            displayFormation();
        } else {
            document.getElementById('battleFormation').style.display = 'none';
        }
    }

    // å ±ååƒæˆ°
    function registerForBattle() {
        if (!currentBattle) {
            showNotification('ç›®å‰æ²’æœ‰é–‹æ”¾çš„å¹«æˆ°å ±å', 'error');
            return;
        }
        const existingRegistration = registrations.find(r =>
            r.userId === currentUser.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time
        );
        if (existingRegistration) {
            showNotification('æ‚¨å·²ç¶“å ±åæ­¤æ¬¡å¹«æˆ°', 'error');
            return;
        }
        const onLeave = leaveRequests.find(r =>
            r.userId === currentUser.id &&
            r.date === currentBattle.date &&
            r.approved
        );
        if (onLeave) {
            showNotification('æ‚¨åœ¨æ­¤æ—¥æœŸå·²è«‹å‡ï¼Œç„¡æ³•å ±å', 'error');
            return;
        }
        const isBackup = isPastDeadline(currentBattle);
        registrations.push({
            userId: currentUser.id,
            userName: currentUser.name,
            userJob: currentUser.job,
            battleDate: currentBattle.date,
            battleTime: currentBattle.time,
            registrationTime: new Date().toISOString(),
            isBackup: isBackup
        });
        showNotification(isBackup ? 'å·²è¶…éå ±åæ™‚é–“ï¼Œç³»çµ±è‡ªå‹•å¹«æ‚¨æ’å…¥å‚™é¸åå–®' : 'å ±åæˆåŠŸï¼', 'success');
        updateHomeContent();
        updateStats();
        updateJobButtonGroup();
    }

    // å–æ¶ˆå ±å
    function cancelRegistration() {
        if (!currentBattle) return;
        if (isPastDeadline(currentBattle)) {
            showNotification('å·²è¶…éå ±åæˆªæ­¢æ™‚é–“ï¼Œè«‹ç›´æ¥DCè¯çµ¡æŒ‡æ®', 'error');
            return;
        }
        const index = registrations.findIndex(r =>
            r.userId === currentUser.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time
        );
        if (index !== -1) {
            registrations.splice(index, 1);
            showNotification('å·²å–æ¶ˆå ±å', 'info');
            updateHomeContent();
            updateStats();
            updateJobButtonGroup();
        }
    }

    // æ›´æ›è·æ¥­ç”³è«‹
    function submitJobChange() {
        const newJob = document.getElementById('newJobSelect').value;
        const reason = document.getElementById('jobChangeReason').value.trim();
        if (!newJob || !reason) {
            showNotification('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
            return;
        }
        if (newJob === currentUser.job) {
            showNotification('æ–°è·æ¥­èˆ‡ç›®å‰è·æ¥­ç›¸åŒ', 'error');
            return;
        }
        if (currentUser.isAdmin) {
            currentUser.job = newJob;
            const memberIndex = members.findIndex(m => m.id === currentUser.id);
            if (memberIndex !== -1) {
                members[memberIndex].job = newJob;
            }
            document.getElementById('userJob').textContent = newJob;
            showNotification('è·æ¥­æ›´æ›æˆåŠŸï¼', 'success');
        } else {
            showNotification('è·æ¥­æ›´æ›ç”³è«‹å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å“¡å¯©æ ¸', 'info');
        }
        document.getElementById('newJobSelect').value = '';
        document.getElementById('jobChangeReason').value = '';
        updateJobButtonGroup();
    }

    // ä»£å ±å
    function submitProxyRegistration() {
        const proxyId = document.getElementById('proxyId').value.trim();
        const reason = document.getElementById('proxyReason').value.trim();
        if (!proxyId || !reason) {
            showNotification('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
            return;
        }
        if (!currentBattle) {
            showNotification('ç›®å‰æ²’æœ‰é–‹æ”¾çš„å¹«æˆ°å ±å', 'error');
            return;
        }
        const targetUser = members.find(m => m.id === proxyId);
        if (!targetUser) {
            showNotification('æ‰¾ä¸åˆ°è©²éŠæˆ²ID', 'error');
            return;
        }
        const existingRegistration = registrations.find(r =>
            r.userId === proxyId && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time
        );
        if (existingRegistration) {
            showNotification('è©²ç”¨æˆ¶å·²ç¶“å ±åæ­¤æ¬¡å¹«æˆ°', 'error');
            return;
        }
        const isBackup = isPastDeadline(currentBattle);
        registrations.push({
            userId: proxyId,
            userName: targetUser.name,
            userJob: targetUser.job,
            battleDate: currentBattle.date,
            battleTime: currentBattle.time,
            registrationTime: new Date().toISOString(),
            proxyBy: currentUser.id,
            proxyReason: reason,
            isBackup: isBackup
        });
        showNotification(`å·²æˆåŠŸç‚º ${targetUser.name} ä»£å ±å${isBackup ? 'ï¼ˆå‚™é¸åå–®ï¼‰' : ''}`, 'success');
        document.getElementById('proxyId').value = '';
        document.getElementById('proxyReason').value = '';
        updateStats();
        updateJobButtonGroup();
    }

    // è«‹å‡ç”³è«‹
    function submitLeaveRequest() {
        const leaveDate = document.getElementById('leaveDate').value;
        const reason = document.getElementById('leaveReason').value.trim();
        if (!leaveDate || !reason) {
            showNotification('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
            return;
        }
        const battle = battles.find(b => b.date === leaveDate);
        if (battle && isPastDeadline(battle)) {
            showNotification('å·²è¶…éå ±åæˆªæ­¢æ™‚é–“ï¼Œè«‹ç›´æ¥DCè¯çµ¡æŒ‡æ®', 'error');
            return;
        }
        const existingLeave = leaveRequests.find(r =>
            r.userId === currentUser.id && r.date === leaveDate
        );
        if (existingLeave) {
            showNotification('æ‚¨åœ¨æ­¤æ—¥æœŸå·²æœ‰è«‹å‡è¨˜éŒ„', 'error');
            return;
        }
        leaveRequests.push({
            userId: currentUser.id,
            userName: currentUser.name,
            date: leaveDate,
            reason: reason,
            approved: currentUser.isAdmin,
            submitTime: new Date().toISOString()
        });
        if (currentUser.isAdmin) {
            const memberIndex = members.findIndex(m => m.id === currentUser.id);
            if (memberIndex !== -1 && leaveDate === (currentBattle?.date)) {
                members[memberIndex].onLeave = true;
            }
            showNotification('è«‹å‡ç”³è«‹å·²æ‰¹å‡†', 'success');
        } else {
            showNotification('è«‹å‡ç”³è«‹å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å“¡å¯©æ ¸', 'info');
        }
        document.getElementById('leaveDate').value = '';
        document.getElementById('leaveReason').value = '';
        updateJobButtonGroup();
    }

    // æ›´æ–°å‡ºå‹¤è¨˜éŒ„å…§å®¹
    function updateRecordsContent() {
        const userRecords = attendanceRecords.filter(r => r.userId === currentUser.id);
        const totalBattles = userRecords.length;
        const attendedBattles = userRecords.filter(r => r.attended).length;
        const attendanceRate = totalBattles > 0 ? Math.round((attendedBattles / totalBattles) * 100) : 0;
        document.getElementById('attendanceRate').textContent = attendanceRate + '%';
        document.getElementById('totalBattles').textContent = attendedBattles;
        document.getElementById('absenceCount').textContent = totalBattles - attendedBattles;
        let recordsHtml = '<h3>è¿‘æœŸå‡ºå‹¤è¨˜éŒ„</h3>';
        if (userRecords.length === 0) {
            recordsHtml += '<p>æš«ç„¡å‡ºå‹¤è¨˜éŒ„</p>';
        } else {
            recordsHtml += '<div class="records-list">';
            userRecords.slice(-10).reverse().forEach(record => {
                const statusClass = record.attended ? 'status-registered' : 'status-not-registered';
                const statusText = record.attended ? 'âœ… å‡ºå¸­' : 'âŒ ç¼ºå¸­';
                recordsHtml += `
                    <div class="admin-section">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${record.battleDate} ${record.battleTime}</strong> - ${record.group ? `ç¬¬${record.group}åœ˜ ` : ''}${record.team || 'æœªåˆ†é…'}
                            </div>
                            <div class="${statusClass}">${statusText}</div>
                        </div>
                    </div>
                `;
            });
            recordsHtml += '</div>';
        }
        document.getElementById('recordsList').innerHTML = recordsHtml;
    }

    // ç®¡ç†å“¡åŠŸèƒ½
    function updateAdminContent() {
        if (!currentUser?.isAdmin) return;
        updateJobButtonGroup();
        updateStats();
    }

    // æª¢æŸ¥æœªç¢ºèªå ´æ¬¡
    function checkUnconfirmedBattles(newBattleDate) {
        return battles.filter(b => !b.confirmed && b.date !== newBattleDate);
    }

    // é–‹æ”¾å ±å
    function openRegistration() {
        const battleDate = document.getElementById('battleDate').value;
        const battleTime = document.getElementById('battleTime').value;
        const deadlineDate = document.getElementById('deadlineDate').value;
        const deadlineTime = document.getElementById('deadlineTime').value;
        if (!battleDate || !battleTime || !deadlineDate || !deadlineTime) {
            showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½', 'error');
            return;
        }
        const deadline = new Date(`${deadlineDate}T${deadlineTime}:00`);
        const battle = new Date(`${battleDate}T${battleTime}:00`);
        if (deadline >= battle) {
            showNotification('å ±åæˆªæ­¢æ™‚é–“å¿…é ˆæ—©æ–¼å¹«æˆ°æ™‚é–“', 'error');
            return;
        }
        const unconfirmedBattles = checkUnconfirmedBattles(battleDate);
        if (unconfirmedBattles.length > 0) {
            const modalContent = `
                <h3>æé†’ï¼šæœªç¢ºèªçš„å ´æ¬¡</h3>
                <p>ä»¥ä¸‹å ´æ¬¡å°šæœªç¢ºèªæœ€çµ‚å‡ºæˆ°è¡¨ï¼š</p>
                <ul>
                    ${unconfirmedBattles.map(b => `<li>${b.date} ${b.time}</li>`).join('')}
                </ul>
                <p>æ˜¯å¦ç¹¼çºŒé–‹æ”¾æ–°å ´æ¬¡ï¼Ÿ</p>
                <div style="margin-top: 20px;">
                    <button onclick="showTab('admin'); showFormationEditor('confirm'); closeModal();" class="btn">å‰å¾€ç¢ºèª</button>
                    <button onclick="proceedOpenRegistration('${battleDate}', '${battleTime}', '${deadlineDate}', '${deadlineTime}'); closeModal();" class="btn btn-success">ç¹¼çºŒé–‹æ”¾</button>
                </div>
            `;
            showModal(modalContent);
        } else {
            proceedOpenRegistration(battleDate, battleTime, deadlineDate, deadlineTime);
        }
    }

    // ç¹¼çºŒé–‹æ”¾å ±å
    function proceedOpenRegistration(battleDate, battleTime, deadlineDate, deadlineTime) {
        currentBattle = {
            date: battleDate,
            time: battleTime,
            deadlineDate: deadlineDate,
            deadlineTime: deadlineTime,
            open: true,
            formationPublished: false,
            formation: [],
            confirmed: false
        };
        battles.push(currentBattle);
        battleFormation = [];
        showNotification(`å·²é–‹æ”¾ ${battleDate} ${battleTime} çš„å ±å`, 'success');
        updateHomeContent();
        updateStats();
        document.getElementById('battleDate').value = '';
        document.getElementById('battleTime').value = '';
        document.getElementById('deadlineDate').value = '';
        document.getElementById('deadlineTime').value = '';
    }

    // é—œé–‰å ±å
    function closeRegistration() {
        if (!currentBattle) {
            showNotification('ç›®å‰æ²’æœ‰é–‹æ”¾çš„å ±å', 'error');
            return;
        }
        currentBattle.open = false;
        showNotification('å·²é—œé–‰ç•¶å‰å ±å', 'success');
        updateHomeContent();
    }

    // æ›´æ–°è·æ¥­æŒ‰éˆ•çµ„
    function updateJobButtonGroup() {
        const container = document.getElementById('jobButtonGroup');
        if (!container) return;
        let html = '';
        jobs.forEach(job => {
            const registeredMembers = registrations
                .filter(r => r.battleDate === currentBattle?.date && r.battleTime === currentBattle?.time)
                .map(r => members.find(m => m.id === r.userId))
                .filter(m => m && m.job === job);
            html += `
                <div>
                    <button class="job-button" onclick="toggleJobMembers('job-${job}')">${job} (${registeredMembers.length})</button>
                    <div id="job-${job}" class="job-members">
                        ${registeredMembers.length ? registeredMembers.map(m => `
                            <span class="member-id" onclick="selectMember('`\({m.id}')">\)`{m.id}${m.onLeave ? ' (è«‹å‡)' : ''}</span>
                        `).join('') : '<span style="font-size: 0.8em; color: #999;">ç„¡å ±åæˆå“¡</span>'}
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // åˆ‡æ›è·æ¥­æˆå“¡é¡¯ç¤º
    function toggleJobMembers(jobId) {
        const element = document.getElementById(jobId);
        const isActive = element.classList.contains('active');
        document.querySelectorAll('.job-members').forEach(el => el.classList.remove('active'));
        if (!isActive) {
            element.classList.add('active');
        }
    }

    // é¸æ“‡æˆå“¡
    function selectMember(memberId) {
        const member = members.find(m => m.id === memberId);
        if (!member) return;
        const modalContent = `
            <h3>æˆå“¡è³‡è¨Š: ${member.name}</h3>
            <p><strong>ID:</strong> ${member.id}</p>
            <p><strong>è·æ¥­:</strong> ${member.job}</p>
            <p><strong>Discord:</strong> ${member.discordId}</p>
            <p><strong>ç‹€æ…‹:</strong> ${member.onLeave ? 'è«‹å‡ä¸­' : 'æ­£å¸¸'}</p>
            <p><strong>æ¬Šé™:</strong> ${member.isAdmin ? 'ç®¡ç†å“¡' : 'ä¸€èˆ¬æˆå“¡'}</p>
            <div style="margin-top: 20px;">
                <button onclick="toggleMemberLeave('${member.id}')" class="btn">
                    ${member.onLeave ? 'è§£é™¤è«‹å‡' : 'è¨­ç‚ºè«‹å‡'}
                </button>
                <button onclick="deleteMember('${member.id}')" class="btn btn-danger">åˆªé™¤æˆå“¡</button>
            </div>
        `;
        showModal(modalContent);
    }

    // åˆ‡æ›æˆå“¡è«‹å‡ç‹€æ…‹
    function toggleMemberLeave(memberId) {
        const memberIndex = members.findIndex(m => m.id === memberId);
        if (memberIndex !== -1) {
            members[memberIndex].onLeave = !members[memberIndex].onLeave;
            updateJobButtonGroup();
            closeModal();
            showNotification('å·²æ›´æ–°æˆå“¡ç‹€æ…‹', 'success');
        }
    }

    // åˆªé™¤æˆå“¡
    function deleteMember(memberId) {
        if (memberId === currentUser.id) {
            showNotification('ä¸èƒ½åˆªé™¤è‡ªå·±çš„å¸³è™Ÿ', 'error');
            return;
        }
        const memberIndex = members.findIndex(m => m.id === memberId);
        if (memberIndex !== -1) {
            members.splice(memberIndex, 1);
            updateJobButtonGroup();
            updateStats();
            closeModal();
            showNotification('å·²åˆªé™¤æˆå“¡', 'success');
        }
    }

    // é¡¯ç¤ºå‡ºæˆ°è¡¨ç·¨è¼¯å™¨
    function showFormationEditor(mode = 'edit') {
        if (!currentBattle) {
            showNotification('è«‹å…ˆé–‹æ”¾å ±å', 'error');
            return;
        }
        document.getElementById('formationEditor').style.display = 'block';
        document.getElementById('confirmFormationBtn').style.display = mode === 'confirm' ? 'inline-block' : 'none';
        generateFormation(mode);
    }

    // ç”Ÿæˆå‡ºæˆ°è¡¨
    function generateFormation(mode) {
        const container = document.getElementById('battleFormation');
        if (!container) return;

        // åˆå§‹åŒ– battleFormation æˆ–å¾ currentBattle.formation è¼‰å…¥
        if (currentBattle.formationPublished && currentBattle.formation.length) {
            battleFormation = JSON.parse(JSON.stringify(currentBattle.formation));
        } else if (!battleFormation.length) {
            battleFormation = Array(2).fill().map(() =>
                Array(5).fill().map(() => ({
                    team: '',
                    slots: Array(6).fill({ job: '', playerId: '' })
                }))
            );
        }

        let html = '';
        battleFormation.forEach((group, groupIndex) => {
            html += `<h4>ç¬¬${groupIndex + 1}åœ˜</h4>`;
            html += `<table class="team-table">`;
            html += `<thead><tr>`;
            for (let teamIdx = 0; teamIdx < 5; teamIdx++) {
                const teamSelectId = `team_${groupIndex}_${teamIdx}`;
                html += `
                    <th colspan="2">
                        <select id="${teamSelectId}" onchange="updateTeamName(${groupIndex}, ${teamIdx})" ${mode === 'confirm' && !battleFormation[groupIndex][teamIdx].team ? '' : 'disabled'}>
                            <option value="">é¸æ“‡å°éšŠ</option>
                            ${teamNames.map(name => `
                                <option value="${name}" `\({battleFormation[groupIndex][teamIdx].team === name ? 'selected' : ''}>\)`{name}</option>
                            `).join('')}
                        </select>
                    </th>
                `;
            }
            html += `</tr></thead>`;
            html += `<tbody>`;
            for (let row = 0; row < 6; row++) {
                html += `<tr>`;
                for (let teamIdx = 0; teamIdx < 5; teamIdx++) {
                    const jobSelectId = `job_${groupIndex}_${teamIdx}_${row}`;
                    const playerSelectId = `player_${groupIndex}_${teamIdx}_${row}`;
                    const slot = battleFormation[groupIndex][teamIdx].slots[row];
                    html += `
                        <td>
                            <select id="${jobSelectId}" onchange="updateFormationCell('${jobSelectId}', '${playerSelectId}', ${groupIndex}, ${teamIdx}, ${row})">
                                <option value="">é¸æ“‡è·æ¥­</option>
                                ${jobs.map(job => `<option value="${job}" `\({slot.job === job ? 'selected' : ''}>\)`{job}</option>`).join('')}
                            </select>
                        </td>
                        <td>
                            <select id="${playerSelectId}" ${slot.job ? '' : 'disabled'}>
                                <option value="">é¸æ“‡ç©å®¶</option>
                                ${slot.job ? members
                                    .filter(m => m.job === slot.job && !m.onLeave && registrations.some(r => r.userId === m.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time))
                                    .map(m => `<option value="${m.id}" `\({slot.playerId === m.id ? 'selected' : ''}>\)`{m.name}</option>`).join('') : ''}
                            </select>
                        </td>
                    `;
                }
                html += `</tr>`;
            }
            html += `</tbody></table>`;
        });
        container.innerHTML = html;
    }

    // æ›´æ–°å°éšŠåç¨±
    function updateTeamName(groupIndex, teamIndex) {
        const select = document.getElementById(`team_${groupIndex}_${teamIndex}`);
        battleFormation[groupIndex][teamIndex].team = select.value;
    }

    // æ›´æ–°å‡ºæˆ°è¡¨æ ¼å­
    function updateFormationCell(jobSelectId, playerSelectId, groupIndex, teamIndex, slotIndex) {
        const jobSelect = document.getElementById(jobSelectId);
        const playerSelect = document.getElementById(playerSelectId);
        const selectedJob = jobSelect.value;
        battleFormation[groupIndex][teamIndex].slots[slotIndex].job = selectedJob;
        battleFormation[groupIndex][teamIndex].slots[slotIndex].playerId = '';
        if (selectedJob) {
            const availablePlayers = members
                .filter(m => m.job === selectedJob && !m.onLeave && registrations.some(r => r.userId === m.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time));
            let options = '<option value="">é¸æ“‡ç©å®¶</option>';
            availablePlayers.forEach(player => {
                options += `<option value="${player.id}">${player.name}</option>`;
            });
            playerSelect.innerHTML = options;
            playerSelect.disabled = false;
            playerSelect.onchange = () => {
                battleFormation[groupIndex][teamIndex].slots[slotIndex].playerId = playerSelect.value;
            };
        } else {
            playerSelect.innerHTML = '<option value="">é¸æ“‡ç©å®¶</option>';
            playerSelect.disabled = true;
        }
    }

    // ç™¼ä½ˆå‡ºæˆ°è¡¨
    function publishFormation() {
        if (!currentBattle) {
            showNotification('è«‹å…ˆé–‹æ”¾å ±å', 'error');
            return;
        }
        // æª¢æŸ¥å°éšŠåç¨±æ˜¯å¦é¸æ“‡
        let hasEmptyTeam = false;
        battleFormation.forEach(group => {
            group.forEach(team => {
                if (team.slots.some(slot => slot.job || slot.playerId) && !team.team) {
                    hasEmptyTeam = true;
                }
            });
        });
        if (hasEmptyTeam) {
            showNotification('è«‹ç‚ºæ‰€æœ‰æœ‰åˆ†é…çš„å°éšŠé¸æ“‡åç¨±', 'error');
            return;
        }
        // æª¢æŸ¥é‡è¤‡åˆ†é…çš„ç©å®¶
        const assignedPlayers = new Set();
        let hasDuplicates = false;
        battleFormation.forEach(group => {
            group.forEach(team => {
                team.slots.forEach(slot => {
                    if (slot.playerId && assignedPlayers.has(slot.playerId)) {
                        hasDuplicates = true;
                    } else if (slot.playerId) {
                        assignedPlayers.add(slot.playerId);
                    }
                });
            });
        });
        if (hasDuplicates) {
            showNotification('å‡ºæˆ°è¡¨ä¸­å­˜åœ¨é‡è¤‡åˆ†é…çš„ç©å®¶ï¼Œè«‹æª¢æŸ¥å¾Œé‡æ–°ç™¼ä½ˆ', 'error');
            return;
        }
        currentBattle.formation = JSON.parse(JSON.stringify(battleFormation));
        currentBattle.formationPublished = true;
        showNotification('å‡ºæˆ°è¡¨å·²ç™¼ä½ˆï¼å·²é€šçŸ¥æ‰€æœ‰åƒæˆ°æˆå“¡', 'success');
        document.getElementById('formationEditor').style.display = 'none';
        updateHomeContent();
    }

    // ç¢ºèªæœ€çµ‚å‡ºæˆ°è¡¨
    function confirmFinalFormation() {
        if (!currentBattle || !currentBattle.formationPublished) {
            showNotification('è«‹å…ˆç™¼ä½ˆå‡ºæˆ°è¡¨', 'error');
            return;
        }
        // æª¢æŸ¥å°éšŠåç¨±æ˜¯å¦é¸æ“‡
        let hasEmptyTeam = false;
        battleFormation.forEach(group => {
            group.forEach(team => {
                if (team.slots.some(slot => slot.job || slot.playerId) && !team.team) {
                    hasEmptyTeam = true;
                }
            });
        });
        if (hasEmptyTeam) {
            showNotification('è«‹ç‚ºæ‰€æœ‰æœ‰åˆ†é…çš„å°éšŠé¸æ“‡åç¨±', 'error');
            return;
        }
        // æª¢æŸ¥é‡è¤‡åˆ†é…çš„ç©å®¶
        const assignedPlayers = new Set();
        let hasDuplicates = false;
        battleFormation.forEach(group => {
            group.forEach(team => {
                team.slots.forEach(slot => {
                    if (slot.playerId && assignedPlayers.has(slot.playerId)) {
                        hasDuplicates = true;
                    } else if (slot.playerId) {
                        assignedPlayers.add(slot.playerId);
                    }
                });
            });
        });
        if (hasDuplicates) {
            showNotification('å‡ºæˆ°è¡¨ä¸­å­˜åœ¨é‡è¤‡åˆ†é…çš„ç©å®¶ï¼Œè«‹æª¢æŸ¥å¾Œé‡æ–°ç¢ºèª', 'error');
            return;
        }
        // æ›´æ–° formation
        currentBattle.formation = JSON.parse(JSON.stringify(battleFormation));
        const battleRegistrations = registrations.filter(r => r.battleDate === currentBattle.date && r.battleTime === currentBattle.time && !r.isBackup);
        battleRegistrations.forEach(reg => {
            let playerGroup = null;
            let playerTeam = null;
            currentBattle.formation.forEach((group, groupIndex) => {
                group.forEach(team => {
                    if (team.slots.some(slot => slot.playerId === reg.userId)) {
                        playerGroup = groupIndex + 1;
                        playerTeam = team.team;
                    }
                });
            });
            attendanceRecords.push({
                userId: reg.userId,
                userName: reg.userName,
                battleDate: currentBattle.date,
                battleTime: currentBattle.time,
                attended: true,
                group: playerGroup,
                team: playerTeam || 'æœªåˆ†é…'
            });
        });
        currentBattle.confirmed = true;
        showNotification('å·²ç¢ºèªæœ€çµ‚å‡ºæˆ°è¡¨ï¼Œå‡ºå‹¤è¨˜éŒ„å·²ç”Ÿæˆ', 'success');
        document.getElementById('formationEditor').style.display = 'none';
        updateRecordsContent();
        updateHomeContent();
    }

    // é¡¯ç¤ºå‡ºæˆ°è¡¨ï¼ˆé¦–é åªè®€ç‰ˆæœ¬ï¼‰
    function displayFormation() {
        const container = document.getElementById('formationDisplay');
        if (!container || !currentBattle.formation) return;
        let html = '';
        currentBattle.formation.forEach((group, groupIndex) => {
            html += `<h4>ç¬¬${groupIndex + 1}åœ˜</h4>`;
            group.forEach(team => {
                const filledSlots = team.slots.filter(slot => slot.job && slot.playerId);
                if (filledSlots.length === 0 || !team.team) return;
                html += `
                    <div class="battle-formation">
                        <h5>${team.team}</h5>
                        <table class="team-table readonly">
                            <thead>
                                <tr>
                                    <th>è·æ¥­</th>
                                    <th>ç©å®¶</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                filledSlots.forEach(slot => {
                    const player = members.find(m => m.id === slot.playerId);
                    html += `
                        <tr>
                            <td>${slot.job}</td>
                            <td>${player ? player.name : '-'}</td>
                        </tr>
                    `;
                });
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });
        });
        container.innerHTML = html || '<p>å‡ºæˆ°è¡¨å°šæœªåˆ†é…ä»»ä½•æˆå“¡</p>';
    }

    // æ›´æ–°çµ±è¨ˆæ•¸æ“š
    function updateStats() {
        const totalMembersEl = document.getElementById('totalMembers');
        if (totalMembersEl) {
            totalMembersEl.textContent = members.length;
        }
        const registeredCountEl = document.getElementById('registeredCount');
        if (registeredCountEl && currentBattle) {
            const count = registrations.filter(r => r.battleDate === currentBattle.date && r.battleTime === currentBattle.time).length;
            registeredCountEl.textContent = count;
        }
        const onLeaveCountEl = document.getElementById('onLeaveCount');
        if (onLeaveCountEl) {
            const count = members.filter(m => m.onLeave).length;
            onLeaveCountEl.textContent = count;
        }
    }

    // é¡¯ç¤ºæ¨¡æ…‹æ¡†
    function showModal(content) {
        document.getElementById('modalContent').innerHTML = content;
        document.getElementById('modal').classList.add('active');
    }

    // é—œé–‰æ¨¡æ…‹æ¡†
    function closeModal() {
        document.getElementById('modal').classList.remove('active');
    }

    // é¡¯ç¤ºé€šçŸ¥
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
    document.getElementById('modal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // åˆå§‹åŒ–ç³»çµ±
    document.addEventListener('DOMContentLoaded', function () {
        initSystem();
    });
</script>