<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹«æˆ°å ±åç®¡ç†ç³»çµ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans TC', 'Roboto', sans-serif;
            background: #F4F7FF;
            min-height: 100vh;
            color: #2D3748;
            overflow-x: hidden;
        }
        .container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }
        .sidebar {
            background: #2A2E45;
            color: #E2E8F0;
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 250px;
            transform: translateX(0);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .sidebar.hidden {
            transform: translateX(-250px);
        }
        .sidebar-header {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .sidebar-nav button {
            background: none;
            border: none;
            color: #E2E8F0;
            padding: 12px 16px;
            text-align: left;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        .sidebar-nav button:hover {
            background: #4B5EAA;
            transform: translateX(5px);
        }
        .sidebar-nav button.active {
            background: #4B5EAA;
            color: #FFF;
        }
        .main-content {
            margin-left: 250px;
            padding: 30px;
            transition: margin-left 0.3s ease;
        }
        .main-content.full {
            margin-left: 0;
        }
        .header {
            background: #FFF;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 2em;
            color: #4B5EAA;
        }
        .hamburger {
            display: none;
            font-size: 1.5em;
            background: none;
            border: none;
            color: #4B5EAA;
            cursor: pointer;
        }
        .tab-content {
            display: none;
            background: #FFF;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            animation: fadeIn 0.5s ease;
        }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .login-container { max-width: 400px; margin: 0 auto; text-align: center; }
        .discord-login {
            background: #5865F2;
            color: #FFF;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }
        .discord-login:hover {
            background: #4752C4;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3);
        }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4A5568;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #4B5EAA;
            box-shadow: 0 0 0 3px rgba(75, 94, 170, 0.1);
            outline: none;
        }
        .btn {
            background: #4B5EAA;
            color: #FFF;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: #3B4A88;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(75, 94, 170, 0.3);
        }
        .btn-danger { background: #EF4444; }
        .btn-danger:hover { background: #DC2626; }
        .btn-success { background: #51CF66; }
        .btn-success:hover { background: #38A169; }
        .registration-card {
            background: #F9FAFB;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #E2E8F0;
            text-align: center;
        }
        .registration-status { font-size: 1.2em; font-weight: 500; margin-bottom: 15px; }
        .status-registered { color: #51CF66; }
        .status-not-registered { color: #6B7280; }
        .admin-section {
            background: #F9FAFB;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #4B5EAA;
        }
        .team-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: #FFF;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .team-table th, .team-table td {
            border: 1px solid #E2E8F0;
            padding: 12px;
            text-align: center;
            font-size: 0.9em;
        }
        .team-table th {
            background: #4B5EAA;
            color: #FFF;
            font-weight: 500;
        }
        .team-table tr:nth-child(even) { background: #F9FAFB; }
        .team-table td select {
            width: 100%;
            padding: 8px;
            border: 1px solid #E2E8F0;
            border-radius: 4px;
            background: #FFF;
        }
        .team-table td select:disabled { background: #EDF2F7; color: #6B7280; }
        .team-table.readonly td { background: #EDF2F7; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stats-card {
            background: #FFF;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #E2E8F0;
            text-align: center;
            transition: transform 0.3s ease;
        }
        .stats-card:hover { transform: translateY(-5px); }
        .stats-number { font-size: 2em; font-weight: 700; color: #4B5EAA; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #FFF;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #6B7280;
        }
        .close-modal:hover { color: #2D3748; }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            color: #4A5568;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: #FFF;
            font-weight: 500;
            z-index: 1001;
            animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s;
        }
        .notification.success { background: #51CF66; }
        .notification.error { background: #EF4444; }
        .notification.info { background: #4B5EAA; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
            .sidebar {
                transform: translateX(-250px);
                width: 200px;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            .hamburger { display: block; }
            .team-table { font-size: 0.8em; }
            .team-table th, .team-table td { padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                ğŸ›¡ï¸ å¹«æˆ°ç³»çµ±
            </div>
            <nav class="sidebar-nav" id="sidebarNav">
                <button onclick="showTab('home')"><span>ğŸ </span> é¦–é </button>
                <button onclick="showTab('applications')"><span>ğŸ“</span> ç”³è«‹å°ˆå€</button>
                <button onclick="showTab('records')"><span>ğŸ“Š</span> å‡ºå‹¤ç´€éŒ„</button>
                <button id="adminSidebarTab" onclick="showTab('admin')" style="display: none;"><span>âš™ï¸</span> ç®¡ç†å“¡</button>
            </nav>
        </aside>
        <main class="main-content" id="mainContent">
            <div class="header">
                <button class="hamburger" onclick="toggleSidebar()">â˜°</button>
                <h1>å¹«æˆ°å ±åç®¡ç†ç³»çµ±</h1>
                <div id="userInfo" class="user-info" style="display: none;">
                    <strong id="userName"></strong> | <span id="userJob"></span>
                    <button onclick="logout()" class="btn btn-danger">ç™»å‡º</button>
                </div>
            </div>
            <div id="loginPage" class="tab-content active">
                <div class="login-container">
                    <h2>æ­¡è¿ä½¿ç”¨å¹«æˆ°å ±åç³»çµ±</h2>
                    <p>è«‹ä½¿ç”¨ Discord å¸³è™Ÿç™»å…¥</p>
                    <div class="form-group">
                        <label>æ¸¬è©¦æ¨¡å¼ï¼šé¸æ“‡ç”¨æˆ¶é¡å‹</label>
                        <select id="loginTypeSelect">
                            <option value="user">æ™®é€šç”¨æˆ¶</option>
                            <option value="admin">ç®¡ç†å“¡</option>
                        </select>
                    </div>
                    <button onclick="discordLogin()" class="discord-login">ğŸ® ä½¿ç”¨ Discord ç™»å…¥</button>
                    <div id="newUserForm" style="display: none; margin-top: 30px;">
                        <h3>é¦–æ¬¡ç™»å…¥è¨­å®š</h3>
                        <div class="form-group">
                            <label>éŠæˆ² ID:</label>
                            <input type="text" id="gameId" placeholder="è«‹è¼¸å…¥æ‚¨çš„éŠæˆ² ID">
                        </div>
                        <div class="form-group">
                            <label>è·æ¥­:</label>
                            <select id="jobSelect">
                                <option value="">è«‹é¸æ“‡è·æ¥­</option>
                                <option value="ç´ å•">ç´ å•</option>
                                <option value="è¡€æ²³">è¡€æ²³</option>
                                <option value="ä¹éˆ">ä¹éˆ</option>
                                <option value="é¾åŸ">é¾åŸ</option>
                                <option value="ç¢å¤¢">ç¢å¤¢</option>
                                <option value="ç¥ç›¸">ç¥ç›¸</option>
                                <option value="éµè¡£">éµè¡£</option>
                            </select>
                        </div>
                        <button onclick="completeRegistration()" class="btn">å®Œæˆè¨»å†Š</button>
                    </div>
                </div>
            </div>
            <div id="mainNav" class="nav-tabs" style="display: none;"></div>
            <div id="home" class="tab-content">
                <div class="registration-card">
                    <h2>ğŸ“… å¹«æˆ°å ±åç‹€æ…‹</h2>
                    <div id="registrationStatus" class="registration-status status-not-registered">ç›®å‰æ²’æœ‰é–‹æ”¾çš„å¹«æˆ°å ±å</div>
                    <div id="registrationDate" style="font-size: 1.1em; margin-bottom: 10px;"></div>
                    <div id="registrationDeadline" style="font-size: 1em; margin-bottom: 10px;"></div>
                    <div id="teamAssignment" style="font-size: 1em; margin-bottom: 10px;"></div>
                    <div id="registrationActions">
                        <button id="registerBtn" onclick="registerForBattle()" class="btn" style="display: none;">å ±ååƒæˆ°</button>
                        <button id="cancelBtn" onclick="cancelRegistration()" class="btn btn-danger" style="display: none;">å–æ¶ˆå ±å</button>
                        <div id="deadlineMessage" style="color: #EF4444; margin-top: 10px; display: none;">å¦‚éœ€æ›´å‹•ï¼Œè«‹è¯ç¹«æŒ‡æ®</div>
                    </div>
                </div>
                <div id="battleFormation" style="display: none;">
                    <h3>ğŸ“‹ å‡ºæˆ°è¡¨</h3>
                    <div id="formationDisplay"></div>
                </div>
            </div>
            <div id="applications" class="tab-content">
                <div class="admin-section">
                    <h3>ğŸ”„ æ›´æ›è·æ¥­ç”³è«‹</h3>
                    <div class="form-group">
                        <label>æ–°è·æ¥­:</label>
                        <select id="newJobSelect">
                            <option value="">è«‹é¸æ“‡æ–°è·æ¥­</option>
                            <option value="ç´ å•">ç´ å•</option>
                            <option value="è¡€æ²³">è¡€æ²³</option>
                            <option value="ä¹éˆ">ä¹éˆ</option>
                            <option value="é¾åŸ">é¾åŸ</option>
                            <option value="ç¢å¤¢">ç¢å¤¢</option>
                            <option value="ç¥ç›¸">ç¥ç›¸</option>
                            <option value="éµè¡£">éµè¡£</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç”³è«‹ç†ç”±:</label>
                        <textarea id="jobChangeReason" placeholder="è«‹èªªæ˜æ›´æ›è·æ¥­çš„åŸå› " rows="3"></textarea>
                    </div>
                    <button onclick="submitJobChange()" class="btn">æäº¤ç”³è«‹</button>
                </div>
                <div class="admin-section">
                    <h3>ğŸ‘¥ ä»£å ±åç³»çµ±</h3>
                    <div class="form-group">
                        <label>ä»£å ±å ID:</label>
                        <input type="text" id="proxyId" placeholder="è«‹è¼¸å…¥è¦ä»£å ±åçš„éŠæˆ² ID">
                    </div>
                    <div class="form-group">
                        <label>ä»£å ±ååŸå› :</label>
                        <textarea id="proxyReason" placeholder="è«‹èªªæ˜ä»£å ±åçš„åŸå› " rows="3"></textarea>
                    </div>
                    <button onclick="submitProxyRegistration()" class="btn">æäº¤ä»£å ±å</button>
                </div>
                <div class="admin-section">
                    <h3>ğŸ¥ è«‹å‡ç”³è«‹</h3>
                    <div class="form-group">
                        <label>è«‹å‡æ—¥æœŸ:</label>
                        <input type="date" id="leaveDate">
                    </div>
                    <div class="form-group">
                        <label>è«‹å‡åŸå› ï¼ˆå¯ç©ºç™½ï¼‰:</label>
                        <textarea id="leaveReason" placeholder="è«‹èªªæ˜è«‹å‡åŸå› " rows="3"></textarea>
                    </div>
                    <button id="leaveSubmitBtn" onclick="submitLeaveRequest()" class="btn">æäº¤è«‹å‡ç”³è«‹</button>
                    <div id="leaveDeadlineMessage" style="color: #EF4444; margin-top: 10px; display: none;">å¦‚éœ€è«‹å‡ï¼Œè«‹è¯ç¹«æŒ‡æ®</div>
                </div>
            </div>
            <div id="records" class="tab-content">
                <h2>ğŸ“Š æˆ‘çš„å‡ºå‹¤ç´€éŒ„</h2>
                <div class="stats-grid">
                    <div class="stats-card">
                        <div class="stats-number" id="attendanceRate">0%</div>
                        <div>å‡ºå‹¤ç‡</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="totalBattles">0</div>
                        <div>ç¸½åƒæˆ°æ¬¡æ•¸</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="absenceCount">0</div>
                        <div>ç¼ºå¸­æ¬¡æ•¸</div>
                    </div>
                </div>
                <div id="recordsList"></div>
            </div>
            <div id="admin" class="tab-content">
                <div class="admin-section">
                    <h3>ğŸ“… é–‹æ”¾å ±åæ—¥æœŸ</h3>
                    <div class="form-group">
                        <label>å¹«æˆ°æ—¥æœŸ:</label>
                        <input type="date" id="battleDate">
                    </div>
                    <div class="form-group">
                        <label>å¹«æˆ°æ™‚é–“:</label>
                        <select id="battleTime">
                        <option value="14:00">14:00</option>
                        <option value="20:00">20:00</option>
                    </select>
                    </div>
                    <div class="form-group">
                        <label>å ±åæˆªæ­¢æ—¥æœŸ:</label>
                        <input type="date" id="deadlineDate">
                    </div>
                    <div class="form-group">
                        <label>å ±åæˆªæ­¢æ™‚é–“:</label>
                        <select id="deadlineTime">
                            <option value="12:00">12:00</option>
                            <option value="18:00">18:00</option>
                            <option value="20:00">20:00</option>
                            <option value="23:59">23:59</option>
                        </select>
                    </div>
                    <button onclick="openRegistration()" class="btn">é–‹æ”¾å ±å</button>
                    <button onclick="closeRegistration()" class="btn btn-danger">é—œé–‰å ±å</button>
                </div>
                <div class="admin-section">
                    <h3>ğŸ‘¥ æˆå“¡ç®¡ç†</h3>
                    <div class="job-button-group" id="jobButtonGroup"></div>
                </div>
                <div class="admin-section">
                    <h3>âš”ï¸ å‡ºæˆ°è¡¨éƒ¨ç½²</h3>
                    <div class="form-group">
                        <button onclick="showFormationEditor('edit')" class="btn">ç·¨è¼¯å‡ºæˆ°è¡¨</button>
                        <button onclick="publishFormation()" class="btn btn-success">ç™¼ä½ˆå‡ºæˆ°è¡¨</button>
                        <button onclick="showFormationEditor('confirm')" class="btn btn-success">ç¢ºèªæœ€çµ‚å‡ºæˆ°è¡¨</button>
                    </div>
                    <div id="formationEditor" style="display: none;">
                        <div class="battle-formation" id="battleFormationContainer"></div>
                        <div id="formationActions" style="text-align: center; margin-top: 20px;">
                            <button id="confirmFormationBtn" onclick="confirmFinalFormation()" class="btn btn-success" style="display: none;">ç¢ºèªæœ€çµ‚å‡ºæˆ°è¡¨</button>
                        </div>
                    </div>
                </div>
                <div class="admin-section">
                    <h3>ğŸ“Š çµ±è¨ˆå ±è¡¨</h3>
                    <div class="stats-grid">
                        <div class="stats-card">
                            <div class="stats-number" id="totalMembers">0</div>
                            <div>ç¸½æˆå“¡æ•¸</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-number" id="registeredCount">0</div>
                            <div>å·²å ±åäººæ•¸</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-number" id="onLeaveCount">0</div>
                            <div>è«‹å‡äººæ•¸</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">Ã—</button>
            <div id="modalContent"></div>
        </div>
    </div>
    <script>
        let currentUser = null;
        let isLoggedIn = false;
        let currentBattle = null;
        let battles = [];
        let members = [];
        let battleFormation = [];
        let registrations = [];
        let leaveRequests = [];
        let attendanceRecords = [];
        let assignedPlayers = new Set();
        const initialMembers = [
            { id: 'player001', discordId: 'admin_user1', name: 'å‹‡è€…', job: 'ç´ å•', isAdmin: true, onLeave: false },
            { id: 'player002', discordId: 'user2', name: 'æ³•å¸«', job: 'è¡€æ²³', isAdmin: false, onLeave: false },
            { id: 'player003', discordId: 'user3', name: 'å¼“æ‰‹', job: 'ä¹éˆ', isAdmin: false, onLeave: false },
            { id: 'player004', discordId: 'user4', name: 'ç‰§å¸«', job: 'é¾åŸ', isAdmin: false, onLeave: false },
            { id: 'player005', discordId: 'user5', name: 'ç›œè³Š', job: 'ç¢å¤¢', isAdmin: false, onLeave: false },
            { id: 'player006', discordId: 'user6', name: 'é¨å£«', job: 'ç¥ç›¸', isAdmin: false, onLeave: false },
            { id: 'player007', discordId: 'user7', name: 'æˆ°å£«', job: 'éµè¡£', isAdmin: false, onLeave: false }
        ];
        const jobs = ['ç´ å•', 'è¡€æ²³', 'ä¹éˆ', 'é¾åŸ', 'ç¢å¤¢', 'ç¥ç›¸', 'éµè¡£'];
        const teamNames = ['é€²æ”»éšŠ', 'é˜²å®ˆéšŠ', 'æ©Ÿå‹•éšŠ', 'ç©ºæ‹†éšŠ', 'æ‹†å¡”éšŠ'];
        function initSystem() {
            members = [...initialMembers];
            updateJobButtonGroup();
            updateStats();
        }
        function discordLogin() {
            showNotification('æ­£åœ¨é€£æ¥ Discord...', 'info');
            setTimeout(() => {
                const loginType = document.getElementById('loginTypeSelect').value;
                let mockDiscordUser;
                if (loginType === 'admin') {
                    mockDiscordUser = { id: 'admin_user1', username: 'AdminUser', avatar: null };
                } else {
                    mockDiscordUser = { id: 'discord_' + Math.random().toString(36).substr(2, 9), username: 'TestUser' + Math.floor(Math.random() * 1000), avatar: null };
                }
                const existingUser = members.find(m => m.discordId === mockDiscordUser.id);
                if (existingUser) {
                    currentUser = existingUser;
                    completeLogin();
                } else {
                    showNotification('Discord æˆæ¬ŠæˆåŠŸï¼è«‹å®Œæˆé¦–æ¬¡è¨­å®š', 'success');
                    document.getElementById('newUserForm').style.display = 'block';
                    currentUser = { discordId: mockDiscordUser.id, discordUsername: mockDiscordUser.username };
                }
            }, 2000);
        }
        function completeRegistration() {
            const gameId = document.getElementById('gameId').value.trim();
            const job = document.getElementById('jobSelect').value;
            const loginType = document.getElementById('loginTypeSelect').value;
            if (!gameId || !job) {
                showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦è³‡è¨Š', 'error');
                return;
            }
            if (members.find(m => m.id === gameId)) {
                showNotification('æ­¤éŠæˆ² ID å·²å­˜åœ¨', 'error');
                return;
            }
            const newUser = {
                id: gameId,
                discordId: currentUser.discordId,
                name: gameId,
                job: job,
                isAdmin: loginType === 'admin',
                onLeave: false
            };
            members.push(newUser);
            currentUser = newUser;
            showNotification('è¨»å†ŠæˆåŠŸï¼', 'success');
            completeLogin();
        }
        function completeLogin() {
            isLoggedIn = true;
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainNav').style.display = 'none';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userJob').textContent = currentUser.job;
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('mainContent').classList.remove('full');
            if (currentUser.isAdmin) {
                document.getElementById('adminSidebarTab').style.display = 'block';
            }
            showTab('home');
            updateUserInterface();
        }
        function logout() {
            currentUser = null;
            isLoggedIn = false;
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('mainNav').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('adminSidebarTab').style.display = 'none';
            document.getElementById('newUserForm').style.display = 'none';
            document.getElementById('gameId').value = '';
            document.getElementById('jobSelect').value = '';
            document.getElementById('loginTypeSelect').value = 'user';
            document.getElementById('mainContent').classList.add('full');
            showNotification('å·²æˆåŠŸç™»å‡º', 'info');
        }
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            const sidebarButtons = document.querySelectorAll('.sidebar-nav button');
            sidebarButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            const activeBtn = document.querySelector(`.sidebar-nav button[onclick="showTab('${tabName}')"]`);
            if (activeBtn) activeBtn.classList.add('active');
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
            }
            switch (tabName) {
                case 'home': updateHomeContent(); break;
                case 'records': updateRecordsContent(); break;
                case 'admin': updateAdminContent(); break;
            }
        }
        function updateUserInterface() {
            updateHomeContent();
            updateJobButtonGroup();
            updateStats();
        }
        function isPastDeadline(battle) {
            if (!battle.deadlineDate || !battle.deadlineTime) return false;
            const deadline = new Date(`${battle.deadlineDate}T${battle.deadlineTime}:00`);
            return new Date() > deadline;
        }
        function updateHomeContent() {
            const statusDiv = document.getElementById('registrationStatus');
            const dateDiv = document.getElementById('registrationDate');
            const deadlineDiv = document.getElementById('registrationDeadline');
            const teamAssignmentDiv = document.getElementById('teamAssignment');
            const registerBtn = document.getElementById('registerBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const deadlineMessage = document.getElementById('deadlineMessage');
            if (currentBattle) {
                const userRegistered = registrations.find(r => r.userId === currentUser.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time);
                if (userRegistered) {
                    statusDiv.textContent = `âœ… ${currentBattle.date} ${currentBattle.time} å·²å ±å${userRegistered.isBackup ? 'ï¼ˆå‚™é¸åå–®ï¼‰' : ''}`;
                    statusDiv.className = 'registration-status status-registered';
                    registerBtn.style.display = 'none';
                    cancelBtn.style.display = isPastDeadline(currentBattle) ? 'none' : 'inline-block';
                } else {
                    statusDiv.textContent = `ğŸ“¢ ${currentBattle.date} ${currentBattle.time} é–‹æ”¾å ±åä¸­`;
                    statusDiv.className = 'registration-status status-not-registered';
                    registerBtn.style.display = 'inline-block';
                    cancelBtn.style.display = 'none';
                }
                dateDiv.textContent = `å¹«æˆ°æ™‚é–“: ${currentBattle.date} ${currentBattle.time}`;
                deadlineDiv.textContent = currentBattle.deadlineDate ? `å ±åæˆªæ­¢: ${currentBattle.deadlineDate} ${currentBattle.deadlineTime}` : '';
                if (currentBattle.formationPublished && currentBattle.formation) {
                    let assignedTeam = null;
                    currentBattle.formation.forEach((group, groupIndex) => {
                        group.forEach(team => {
                            if (team.slots.some(slot => slot.playerId === currentUser.id)) {
                                assignedTeam = `æ‚¨è¢«åˆ†é…åˆ°ç¬¬${groupIndex + 1}åœ˜ ${team.team}`;
                            }
                        });
                    });
                    teamAssignmentDiv.textContent = assignedTeam || 'æ‚¨å°šæœªè¢«åˆ†é…åˆ°ä»»ä½•å°éšŠ';
                } else {
                    teamAssignmentDiv.textContent = '';
                }
                deadlineMessage.style.display = isPastDeadline(currentBattle) ? 'block' : 'none';
                document.getElementById('leaveDeadlineMessage').style.display = isPastDeadline(currentBattle) ? 'block' : 'none';
                document.getElementById('leaveSubmitBtn').style.display = isPastDeadline(currentBattle) ? 'none' : 'inline-block';
            } else {
                statusDiv.textContent = 'ç›®å‰æ²’æœ‰é–‹æ”¾çš„å¹«æˆ°å ±å';
                statusDiv.className = 'registration-status status-not-registered';
                dateDiv.textContent = '';
                deadlineDiv.textContent = '';
                teamAssignmentDiv.textContent = '';
                registerBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
                deadlineMessage.style.display = 'none';
                document.getElementById('leaveDeadlineMessage').style.display = 'none';
                document.getElementById('leaveSubmitBtn').style.display = 'inline-block';
            }
            if (currentBattle && currentBattle.formationPublished) {
                document.getElementById('battleFormation').style.display = 'block';
                displayFormation();
            } else {
                document.getElementById('battleFormation').style.display = 'none';
            }
        }
        function registerForBattle() {
            if (!currentBattle) {
                showNotification('ç›®å‰æ²’æœ‰é–‹æ”¾çš„å¹«æˆ°å ±å', 'error');
                return;
            }
            const existingRegistration = registrations.find(r => r.userId === currentUser.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time);
            if (existingRegistration) {
                showNotification('æ‚¨å·²ç¶“å ±åæ­¤æ¬¡å¹«æˆ°', 'error');
                return;
            }
            const onLeave = leaveRequests.find(r => r.userId === currentUser.id && r.date === currentBattle.date && r.approved);
            if (onLeave) {
                showNotification('æ‚¨åœ¨æ­¤æ—¥æœŸå·²è«‹å‡ï¼Œç„¡æ³•å ±å', 'error');
                return;
            }
            const isBackup = isPastDeadline(currentBattle);
            registrations.push({
                userId: currentUser.id,
                userName: currentUser.name,
                userJob: currentUser.job,
                battleDate: currentBattle.date,
                battleTime: currentBattle.time,
                registrationTime: new Date().toISOString(),
                isBackup: isBackup
            });
            showNotification(isBackup ? 'å·²è¶…éå ±åæ™‚é–“ï¼Œç³»çµ±è‡ªå‹•å¹«æ‚¨æ’å…¥å‚™é¸åå–®' : 'å ±åæˆåŠŸï¼', 'success');
            updateHomeContent();
            updateStats();
            updateJobButtonGroup();
        }
        function cancelRegistration() {
            if (!currentBattle) return;
            if (isPastDeadline(currentBattle)) {
                showNotification('å·²è¶…éå ±åæˆªæ­¢æ™‚é–“ï¼Œè«‹è¯ç¹«æŒ‡æ®', 'error');
                return;
            }
            const index = registrations.findIndex(r => r.userId === currentUser.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time);
            if (index !== -1) {
                registrations.splice(index, 1);
                showNotification('å·²å–æ¶ˆå ±å', 'info');
                updateHomeContent();
                updateStats();
                updateJobButtonGroup();
            }
        }
        function submitJobChange() {
            const newJob = document.getElementById('newJobSelect').value;
            const reason = document.getElementById('jobChangeReason').value.trim();
            if (!newJob || !reason) {
                showNotification('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
                return;
            }
            if (newJob === currentUser.job) {
                showNotification('æ–°è·æ¥­èˆ‡ç›®å‰è·æ¥­ç›¸åŒ', 'error');
                return;
            }
            if (currentUser.isAdmin) {
                currentUser.job = newJob;
                const memberIndex = members.findIndex(m => m.id === currentUser.id);
                if (memberIndex !== -1) {
                    members[memberIndex].job = newJob;
                }
                document.getElementById('userJob').textContent = newJob;
                showNotification('è·æ¥­æ›´æ›æˆåŠŸï¼', 'success');
            } else {
                showNotification('è·æ¥­æ›´æ›ç”³è«‹å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å“¡å¯©æ ¸', 'info');
            }
            document.getElementById('newJobSelect').value = '';
            document.getElementById('jobChangeReason').value = '';
            updateJobButtonGroup();
        }
        function submitProxyRegistration() {
            const proxyId = document.getElementById('proxyId').value.trim();
            const reason = document.getElementById('proxyReason').value.trim();
            if (!proxyId || !reason) {
                showNotification('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
                return;
            }
            if (!currentBattle) {
                showNotification('ç›®å‰æ²’æœ‰é–‹æ”¾çš„å¹«æˆ°å ±å', 'error');
                return;
            }
            const targetUser = members.find(m => m.id === proxyId);
            if (!targetUser) {
                showNotification('æ‰¾ä¸åˆ°è©²éŠæˆ² ID', 'error');
                return;
            }
            const existingRegistration = registrations.find(r => r.userId === proxyId && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time);
            if (existingRegistration) {
                showNotification('è©²ç”¨æˆ¶å·²ç¶“å ±åæ­¤æ¬¡å¹«æˆ°', 'error');
                return;
            }
            const isBackup = isPastDeadline(currentBattle);
            registrations.push({
                userId: proxyId,
                userName: targetUser.name,
                userJob: targetUser.job,
                battleDate: currentBattle.date,
                battleTime: currentBattle.time,
                registrationTime: new Date().toISOString(),
                proxyBy: currentUser.id,
                proxyReason: reason,
                isBackup: isBackup
            });
            showNotification(`å·²æˆåŠŸç‚º ${targetUser.name} ä»£å ±å${isBackup ? 'ï¼ˆå‚™é¸åå–®ï¼‰' : ''}`, 'success');
            document.getElementById('proxyId').value = '';
            document.getElementById('proxyReason').value = '';
            updateStats();
            updateJobButtonGroup();
        }
        function submitLeaveRequest() {
            const leaveDate = document.getElementById('leaveDate').value;
            const reason = document.getElementById('leaveReason').value.trim();
            if (!leaveDate || !reason) {
                showNotification('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
                return;
            }
            const battle = battles.find(b => b.date === leaveDate);
            if (battle && isPastDeadline(battle)) {
                showNotification('å·²è¶…éå ±åæˆªæ­¢æ™‚é–“ï¼Œè«‹è¯ç¹«æŒ‡æ®', 'error');
                return;
            }
            const existingLeave = leaveRequests.find(r => r.userId === currentUser.id && r.date === leaveDate);
            if (existingLeave) {
                showNotification('æ‚¨åœ¨æ­¤æ—¥æœŸå·²æœ‰è«‹å‡è¨˜éŒ„', 'error');
                return;
            }
            leaveRequests.push({
                userId: currentUser.id,
                userName: currentUser.name,
                date: leaveDate,
                reason: reason,
                approved: currentUser.isAdmin,
                submitTime: new Date().toISOString()
            });
            if (currentUser.isAdmin) {
                const memberIndex = members.findIndex(m => m.id === currentUser.id);
                if (memberIndex !== -1 && leaveDate === (currentBattle?.date)) {
                    members[memberIndex].onLeave = true;
                }
                showNotification('è«‹å‡ç”³è«‹å·²æ‰¹å‡†', 'success');
            } else {
                showNotification('è«‹å‡ç”³è«‹å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å“¡å¯©æ ¸', 'info');
            }
            document.getElementById('leaveDate').value = '';
            document.getElementById('leaveReason').value = '';
            updateJobButtonGroup();
        }
        function updateRecordsContent() {
            const userRecords = attendanceRecords.filter(r => r.userId === currentUser.id);
            const totalBattles = userRecords.length;
            const attendedBattles = userRecords.filter(r => r.attended).length;
            const attendanceRate = totalBattles > 0 ? Math.round((attendedBattles / totalBattles) * 100) : 0;
            document.getElementById('attendanceRate').textContent = attendanceRate + '%';
            document.getElementById('totalBattles').textContent = attendedBattles;
            document.getElementById('absenceCount').textContent = totalBattles - attendedBattles;
            let recordsHtml = '<h3>è¿‘æœŸå‡ºå‹¤è¨˜éŒ„</h3>';
            if (userRecords.length === 0) {
                recordsHtml += '<p>æš«ç„¡å‡ºå‹¤è¨˜éŒ„</p>';
            } else {
                recordsHtml += '<div class="records-list">';
                userRecords.slice(-10).reverse().forEach(record => {
                    const statusClass = record.attended ? 'status-registered' : 'status-not-registered';
                    const statusText = record.attended ? 'âœ… å‡ºå¸­' : 'âŒ ç¼ºå¸­';
                    recordsHtml += `
                        <div class="admin-section">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${record.battleDate} ${record.battleTime}</strong> - ${record.group ? `ç¬¬${record.group}åœ˜ ` : ''}${record.team || 'æœªåˆ†é…'}
                                </div>
                                <div class="${statusClass}">${statusText}</div>
                            </div>
                        </div>
                    `;
                });
                recordsHtml += '</div>';
            }
            document.getElementById('recordsList').innerHTML = recordsHtml;
        }
        function updateAdminContent() {
            if (!currentUser?.isAdmin) return;
            updateJobButtonGroup();
            updateStats();
        }
        function checkUnconfirmedBattles(newBattleDate) {
            return battles.filter(b => !b.confirmed && b.date !== newBattleDate);
        }
        function openRegistration() {
            const battleDate = document.getElementById('battleDate').value;
            const battleTime = document.getElementById('battleTime').value;
            const deadlineDate = document.getElementById('deadlineDate').value;
            const deadlineTime = document.getElementById('deadlineTime').value;
            if (!battleDate || !battleTime || !deadlineDate || !deadlineTime) {
                showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½', 'error');
                return;
            }
            const deadline = new Date(`${deadlineDate}T${deadlineTime}:00`);
            const battle = new Date(`${battleDate}T${battleTime}:00`);
            if (deadline >= battle) {
                showNotification('å ±åæˆªæ­¢æ™‚é–“å¿…é ˆæ—©æ–¼å¹«æˆ°æ™‚é–“', 'error');
                return;
            }
            const unconfirmedBattles = checkUnconfirmedBattles(battleDate);
            if (unconfirmedBattles.length > 0) {
                const modalContent = `
                    <h3>æé†’ï¼šæœªç¢ºèªçš„å ´æ¬¡</h3>
                    <p>ä»¥ä¸‹å ´æ¬¡å°šæœªç¢ºèªæœ€çµ‚å‡ºæˆ°è¡¨ï¼š</p>
                    <ul>
                        ${unconfirmedBattles.map(b => `<li>${b.date} ${b.time}</li>`).join('')}
                    </ul>
                    <p>æ˜¯å¦ç¹¼çºŒé–‹æ”¾æ–°å ´æ¬¡ï¼Ÿ</p>
                    <div style="margin-top: 20px;">
                        <button onclick="showTab('admin'); showFormationEditor('confirm'); closeModal();" class="btn">å‰å¾€ç¢ºèª</button>
                        <button onclick="proceedOpenRegistration('${battleDate}', '${battleTime}', '${deadlineDate}', '${deadlineTime}'); closeModal();" class="btn btn-success">ç¹¼çºŒé–‹æ”¾</button>
                    </div>
                `;
                showModal(modalContent);
            } else {
                proceedOpenRegistration(battleDate, battleTime, deadlineDate, deadlineTime);
            }
        }
        function proceedOpenRegistration(battleDate, battleTime, deadlineDate, deadlineTime) {
            currentBattle = {
                date: battleDate,
                time: battleTime,
                deadlineDate: deadlineDate,
                deadlineTime: deadlineTime,
                open: true,
                formationPublished: false,
                formation: [],
                confirmed: false
            };
            battles.push(currentBattle);
            battleFormation = [];
            assignedPlayers.clear();
            showNotification(`å·²é–‹æ”¾ ${battleDate} ${battleTime} çš„å ±å`, 'success');
            updateHomeContent();
            updateStats();
            document.getElementById('battleDate').value = '';
            document.getElementById('battleTime').value = '';
            document.getElementById('deadlineDate').value = '';
            document.getElementById('deadlineTime').value = '';
        }
        function closeRegistration() {
            if (!currentBattle) {
                showNotification('ç›®å‰æ²’æœ‰é–‹æ”¾çš„å ±å', 'error');
                return;
            }
            currentBattle.open = false;
            showNotification('å·²é—œé–‰ç•¶å‰å ±å', 'success');
            updateHomeContent();
        }
        function updateJobButtonGroup() {
            const container = document.getElementById('jobButtonGroup');
            if (!container) return;
            let html = '';
            jobs.forEach(job => {
                const registeredMembers = registrations
                    .filter(r => r.battleDate === currentBattle?.date && r.battleTime === currentBattle?.time)
                    .map(r => members.find(m => m.id === r.userId))
                    .filter(m => m && m.job === job);
                html += `
                    <div>
                        <button class="job-button" onclick="toggleJobMembers('job-${job}')">${job} (${registeredMembers.length})</button>
                        <div id="job-${job}" class="job-members">
                            ${registeredMembers.length ? registeredMembers.map(m => `
                                <span class="member-id" onclick="selectMember('${m.id}')">${m.id}${m.onLeave ? ' (è«‹å‡)' : ''}</span>
                            `).join('') : '<span style="font-size: 0.8em; color: #999;">ç„¡å ±åæˆå“¡</span>'}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        function toggleJobMembers(jobId) {
            const element = document.getElementById(jobId);
            const isActive = element.classList.contains('active');
            document.querySelectorAll('.job-members').forEach(el => el.classList.remove('active'));
            if (!isActive) {
                element.classList.add('active');
            }
        }
        function selectMember(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            const modalContent = `
                <h3>æˆå“¡è³‡è¨Š: ${member.name}</h3>
                <p><strong>ID:</strong> ${member.id}</p>
                <p><strong>è·æ¥­:</strong> ${member.job}</p>
                <p><strong>Discord:</strong> ${member.discordId}</p>
                <p><strong>ç‹€æ…‹:</strong> ${member.onLeave ? 'è«‹å‡ä¸­' : 'æ­£å¸¸'}</p>
                <p><strong>æ¬Šé™:</strong> ${member.isAdmin ? 'ç®¡ç†å“¡' : 'ä¸€èˆ¬æˆå“¡'}</p>
                <div style="margin-top: 20px;">
                    <button onclick="toggleMemberLeave('${member.id}')" class="btn">${member.onLeave ? 'è§£é™¤è«‹å‡' : 'è¨­ç‚ºè«‹å‡'}</button>
                    <button onclick="deleteMember('${member.id}')" class="btn btn-danger">åˆªé™¤æˆå“¡</button>
                </div>
            `;
            showModal(modalContent);
        }
        function toggleMemberLeave(memberId) {
            const memberIndex = members.findIndex(m => m.id === memberId);
            if (memberIndex !== -1) {
                members[memberIndex].onLeave = !members[memberIndex].onLeave;
                updateJobButtonGroup();
                closeModal();
                showNotification('å·²æ›´æ–°æˆå“¡ç‹€æ…‹', 'success');
            }
        }
        function deleteMember(memberId) {
            if (memberId === currentUser.id) {
                showNotification('ä¸èƒ½åˆªé™¤è‡ªå·±çš„å¸³è™Ÿ', 'error');
                return;
            }
            const memberIndex = members.findIndex(m => m.id === memberId);
            if (memberIndex !== -1) {
                members.splice(memberIndex, 1);
                updateJobButtonGroup();
                updateStats();
                closeModal();
                showNotification('å·²åˆªé™¤æˆå“¡', 'success');
            }
        }
        function showFormationEditor(mode = 'edit') {
            if (!currentBattle) {
                showNotification('è«‹å…ˆé–‹æ”¾å ±å', 'error');
                return;
            }
            const editor = document.getElementById('formationEditor');
            const confirmBtn = document.getElementById('confirmFormationBtn');
            if (!editor || !confirmBtn) {
                showNotification('é é¢å…ƒç´ è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢', 'error');
                return;
            }
            editor.style.display = 'block';
            confirmBtn.style.display = mode === 'confirm' ? 'inline-block' : 'none';
            assignedPlayers.clear();
            battleFormation.forEach(group => {
                group.forEach(team => {
                    team.slots.forEach(slot => {
                        if (slot.playerId) assignedPlayers.add(slot.playerId);
                    });
                });
            });
            generateFormation(mode);
        }
        function generateFormation(mode) {
            const container = document.getElementById('battleFormationContainer');
            if (!container) {
                showNotification('å‡ºæˆ°è¡¨å®¹å™¨æœªæ‰¾åˆ°', 'error');
                return;
            }
            if (currentBattle.formationPublished && currentBattle.formation.length) {
                battleFormation = JSON.parse(JSON.stringify(currentBattle.formation));
            } else if (!battleFormation.length) {
                battleFormation = Array(2).fill().map(() =>
                    Array(5).fill().map(() => ({
                        team: '',
                        slots: Array(6).fill().map(() => ({ job: '', playerId: '' }))
                    }))
                );
            }
            let html = '';
            battleFormation.forEach((group, groupIndex) => {
                html += `<h4>ç¬¬${groupIndex + 1}åœ˜</h4>`;
                html += `<table class="team-table">`;
                html += `<thead><tr>`;
                for (let teamIdx = 0; teamIdx < 5; teamIdx++) {
                    const teamSelectId = `team_${groupIndex}_${teamIdx}`;
                    const isDisabled = mode === 'confirm' && battleFormation[groupIndex][teamIdx].team ? 'disabled' : '';
                    html += `
                        <th colspan="2">
                            <select id="${teamSelectId}" onchange="updateTeamName(${groupIndex}, ${teamIdx})" ${isDisabled}>
                                <option value="">é¸æ“‡å°éšŠ</option>
                                ${teamNames.map(name => `
                                    <option value="${name}" ${battleFormation[groupIndex][teamIdx].team === name ? 'selected' : ''}>${name}</option>
                                `).join('')}
                            </select>
                        </th>
                    `;
                }
                html += `</tr></thead>`;
                html += `<tbody>`;
                for (let row = 0; row < 6; row++) {
                    html += `<tr>`;
                    for (let teamIdx = 0; teamIdx < 5; teamIdx++) {
                        const jobSelectId = `job_${groupIndex}_${teamIdx}_${row}`;
                        const playerSelectId = `player_${groupIndex}_${teamIdx}_${row}`;
                        const slot = battleFormation[groupIndex][teamIdx].slots[row] || { job: '', playerId: '' };
                        html += `
                            <td>
                                <select id="${jobSelectId}" onchange="updateFormationCell('${jobSelectId}', '${playerSelectId}', ${groupIndex}, ${teamIdx}, ${row})">
                                    <option value="">é¸æ“‡è·æ¥­</option>
                                    ${jobs.map(job => `<option value="${job}" ${slot.job === job ? 'selected' : ''}>${job}</option>`).join('')}
                                </select>
                            </td>
                            <td>
                                <select id="${playerSelectId}" ${slot.job ? '' : 'disabled'} onchange="updatePlayerSelection('${playerSelectId}', ${groupIndex}, ${teamIdx}, ${row})">
                                    <option value="">é¸æ“‡ç©å®¶</option>
                                    ${slot.job ? members
                                        .filter(m => m.job === slot.job && !m.onLeave && registrations.some(r => r.userId === m.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time) && !assignedPlayers.has(m.id))
                                        .map(m => `<option value="${m.id}" ${slot.playerId === m.id ? 'selected' : ''}>${m.name}</option>`).join('') : ''}
                                </select>
                            </td>
                        `;
                    }
                    html += `</tr>`;
                }
                html += `</tbody></table>`;
            });
            container.innerHTML = html;
        }
        function updateTeamName(groupIndex, teamIndex) {
            const select = document.getElementById(`team_${groupIndex}_${teamIndex}`);
            if (select) {
                battleFormation[groupIndex][teamIndex].team = select.value;
            }
        }
        function updateFormationCell(jobSelectId, playerSelectId, groupIndex, teamIndex, slotIndex) {
            const jobSelect = document.getElementById(jobSelectId);
            const playerSelect = document.getElementById(playerSelectId);
            if (!jobSelect || !playerSelect) return;
            const previousPlayerId = battleFormation[groupIndex][teamIndex].slots[slotIndex].playerId;
            if (previousPlayerId) {
                assignedPlayers.delete(previousPlayerId);
            }
            const selectedJob = jobSelect.value;
            battleFormation[groupIndex][teamIndex].slots[slotIndex].job = selectedJob;
            battleFormation[groupIndex][teamIndex].slots[slotIndex].playerId = '';
            if (selectedJob) {
                const availablePlayers = members
                    .filter(m => m.job === selectedJob && !m.onLeave && registrations.some(r => r.userId === m.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time) && !assignedPlayers.has(m.id));
                let options = '<option value="">é¸æ“‡ç©å®¶</option>';
                availablePlayers.forEach(player => {
                    options += `<option value="${player.id}">${player.name}</option>`;
                });
                playerSelect.innerHTML = options;
                playerSelect.disabled = false;
            } else {
                playerSelect.innerHTML = '<option value="">é¸æ“‡ç©å®¶</option>';
                playerSelect.disabled = true;
            }
            updateAllPlayerSelects();
        }
        function updatePlayerSelection(playerSelectId, groupIndex, teamIndex, slotIndex) {
            const playerSelect = document.getElementById(playerSelectId);
            if (!playerSelect) return;
            const previousPlayerId = battleFormation[groupIndex][teamIndex].slots[slotIndex].playerId;
            if (previousPlayerId) {
                assignedPlayers.delete(previousPlayerId);
            }
            const selectedPlayerId = playerSelect.value;
            battleFormation[groupIndex][teamIndex].slots[slotIndex].playerId = selectedPlayerId;
            if (selectedPlayerId) {
                assignedPlayers.add(selectedPlayerId);
            }
            updateAllPlayerSelects();
        }
        function updateAllPlayerSelects() {
            battleFormation.forEach((group, groupIndex) => {
                group.forEach((team, teamIndex) => {
                    team.slots.forEach((slot, slotIndex) => {
                        const playerSelectId = `player_${groupIndex}_${teamIndex}_${slotIndex}`;
                        const playerSelect = document.getElementById(playerSelectId);
                        if (playerSelect && slot.job) {
                            const currentValue = playerSelect.value;
                            const availablePlayers = members
                                .filter(m => m.job === slot.job && !m.onLeave && registrations.some(r => r.userId === m.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time) && (!assignedPlayers.has(m.id) || m.id === currentValue));
                            let options = '<option value="">é¸æ“‡ç©å®¶</option>';
                            availablePlayers.forEach(player => {
                                options += `<option value="${player.id}" ${player.id === currentValue ? 'selected' : ''}>${player.name}</option>`;
                            });
                            playerSelect.innerHTML = options;
                        }
                    });
                });
            });
        }
        function publishFormation() {
            if (!currentBattle) {
                showNotification('è«‹å…ˆé–‹æ”¾å ±å', 'error');
                return;
            }
            let hasEmptyTeam = false;
            battleFormation.forEach(group => {
                group.forEach(team => {
                    if (team.slots.some(slot => slot.job || slot.playerId) && !team.team) {
                        hasEmptyTeam = true;
                    }
                });
            });
            if (hasEmptyTeam) {
                showNotification('è«‹ç‚ºæ‰€æœ‰æœ‰åˆ†é…çš„å°éšŠé¸æ“‡åç¨±', 'error');
                return;
            }
            const assignedPlayersCheck = new Set();
            let hasDuplicates = false;
            battleFormation.forEach(group => {
                group.forEach(team => {
                    team.slots.forEach(slot => {
                        if (slot.playerId && assignedPlayersCheck.has(slot.playerId)) {
                            hasDuplicates = true;
                        } else if (slot.playerId) {
                            assignedPlayersCheck.add(slot.playerId);
                        }
                    });
                });
            });
            if (hasDuplicates) {
                showNotification('å‡ºæˆ°è¡¨ä¸­å­˜åœ¨é‡è¤‡åˆ†é…çš„ç©å®¶ï¼Œè«‹æª¢æŸ¥å¾Œé‡æ–°ç™¼ä½ˆ', 'error');
                return;
            }
            currentBattle.formation = JSON.parse(JSON.stringify(battleFormation));
            currentBattle.formationPublished = true;
            showNotification('å‡ºæˆ°è¡¨å·²ç™¼ä½ˆï¼å·²é€šçŸ¥æ‰€æœ‰åƒæˆ°æˆå“¡', 'success');
            document.getElementById('formationEditor').style.display = 'none';
            updateHomeContent();
        }
        function confirmFinalFormation() {
            if (!currentBattle || !currentBattle.formationPublished) {
                showNotification('è«‹å…ˆç™¼ä½ˆå‡ºæˆ°è¡¨', 'error');
                return;
            }
            let hasEmptyTeam = false;
            battleFormation.forEach(group => {
                group.forEach(team => {
                    if (team.slots.some(slot => slot.job || slot.playerId) && !team.team) {
                        hasEmptyTeam = true;
                    }
                });
            });
            if (hasEmptyTeam) {
                showNotification('è«‹ç‚ºæ‰€æœ‰æœ‰åˆ†é…çš„å°éšŠé¸æ“‡åç¨±', 'error');
                return;
            }
            const assignedPlayersCheck = new Set();
            let hasDuplicates = false;
            battleFormation.forEach(group => {
                group.forEach(team => {
                    team.slots.forEach(slot => {
                        if (slot.playerId && assignedPlayersCheck.has(slot.playerId)) {
                            hasDuplicates = true;
                        } else if (slot.playerId) {
                            assignedPlayersCheck.add(slot.playerId);
                        }
                    });
                });
            });
            if (hasDuplicates) {
                showNotification('å‡ºæˆ°è¡¨ä¸­å­˜åœ¨é‡è¤‡åˆ†é…çš„ç©å®¶ï¼Œè«‹æª¢æŸ¥å¾Œé‡æ–°ç¢ºèª', 'error');
                return;
            }
            currentBattle.formation = JSON.parse(JSON.stringify(battleFormation));
            const battleRegistrations = registrations.filter(r => r.battleDate === currentBattle.date && r.battleTime === currentBattle.time && !r.isBackup);
            battleRegistrations.forEach(reg => {
                let playerGroup = null;
                let playerTeam = null;
                currentBattle.formation.forEach((group, groupIndex) => {
                    group.forEach(team => {
                        if (team.slots.some(slot => slot.playerId === reg.userId)) {
                            playerGroup = groupIndex + 1;
                            playerTeam = team.team;
                        }
                    });
                });
                attendanceRecords.push({
                    userId: reg.userId,
                    userName: reg.userName,
                    battleDate: currentBattle.date,
                    battleTime: currentBattle.time,
                    attended: true,
                    group: playerGroup,
                    team: playerTeam || 'æœªåˆ†é…'
                });
            });
            currentBattle.confirmed = true;
            showNotification('å·²ç¢ºèªæœ€çµ‚å‡ºæˆ°è¡¨ï¼Œå‡ºå‹¤è¨˜éŒ„å·²ç”Ÿæˆ', 'success');
            document.getElementById('formationEditor').style.display = 'none';
            updateRecordsContent();
            updateHomeContent();
        }
        function displayFormation() {
            const container = document.getElementById('formationDisplay');
            if (!container || !currentBattle.formation) return;
            let html = '';
            currentBattle.formation.forEach((group, groupIndex) => {
                html += `<h4>ç¬¬${groupIndex + 1}åœ˜</h4>`;
                group.forEach(team => {
                    const filledSlots = team.slots.filter(slot => slot.job && slot.playerId);
                    if (filledSlots.length === 0 || !team.team) return;
                    html += `
                        <div class="battle-formation">
                            <h5>${team.team}</h5>
                            <table class="team-table readonly">
                                <thead><tr><th>è·æ¥­</th><th>ç©å®¶</th></tr></thead>
                                <tbody>
                    `;
                    filledSlots.forEach(slot => {
                        const player = members.find(m => m.id === slot.playerId);
                        html += `
                            <tr>
                                <td>${slot.job}</td>
                                <td>${player ? player.name : '-'}</td>
                            </tr>
                        `;
                    });
                    html += `</tbody></table></div>`;
                });
            });
            container.innerHTML = html || '<p>å‡ºæˆ°è¡¨å°šæœªåˆ†é…ä»»ä½•æˆå“¡</p>';
        }
        function updateStats() {
            const totalMembersEl = document.getElementById('totalMembers');
            if (totalMembersEl) totalMembersEl.textContent = members.length;
            const registeredCountEl = document.getElementById('registeredCount');
            if (registeredCountEl && currentBattle) {
                const count = registrations.filter(r => r.battleDate === currentBattle.date && r.battleTime === currentBattle.time).length;
                registeredCountEl.textContent = count;
            }
            const onLeaveCountEl = document.getElementById('onLeaveCount');
            if (onLeaveCountEl) onLeaveCountEl.textContent = members.filter(m => m.onLeave).length;
        }
        function showModal(content) {
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
        document.getElementById('modal').addEventListener('click', function (e) {
            if (e.target === this) closeModal();
        });
        document.addEventListener('DOMContentLoaded', initSystem);
    </script>
</body>
</html>
