<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幫戰報名管理系統</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans TC', 'Roboto', sans-serif;
            background: #F4F7FF;
            min-height: 100vh;
            color: #2D3748;
            overflow-x: hidden;
        }
        .container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }
        .sidebar {
            background: #2A2E45;
            color: #E2E8F0;
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 250px;
            transform: translateX(0);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .sidebar.hidden {
            transform: translateX(-250px);
        }
        .sidebar-header {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .sidebar-nav button {
            background: none;
            border: none;
            color: #E2E8F0;
            padding: 12px 16px;
            text-align: left;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        .sidebar-nav button:hover {
            background: #4B5EAA;
            transform: translateX(5px);
        }
        .sidebar-nav button.active {
            background: #4B5EAA;
            color: #FFF;
        }
        .main-content {
            margin-left: 250px;
            padding: 30px;
            transition: margin-left 0.3s ease;
        }
        .main-content.full {
            margin-left: 0;
        }
        .header {
            background: #FFF;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 2em;
            color: #4B5EAA;
        }
        .hamburger {
            display: none;
            font-size: 1.5em;
            background: none;
            border: none;
            color: #4B5EAA;
            cursor: pointer;
        }
        .tab-content {
            display: none;
            background: #FFF;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            animation: fadeIn 0.5s ease;
        }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .login-container { max-width: 400px; margin: 0 auto; text-align: center; }
        .discord-login {
            background: #5865F2;
            color: #FFF;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }
        .discord-login:hover {
            background: #4752C4;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3);
        }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4A5568;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #4B5EAA;
            box-shadow: 0 0 0 3px rgba(75, 94, 170, 0.1);
            outline: none;
        }
        .btn {
            background: #4B5EAA;
            color: #FFF;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: #3B4A88;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(75, 94, 170, 0.3);
        }
        .btn-danger { background: #EF4444; }
        .btn-danger:hover { background: #DC2626; }
        .btn-success { background: #51CF66; }
        .btn-success:hover { background: #38A169; }
        .registration-card {
            background: #F9FAFB;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #E2E8F0;
            text-align: center;
        }
        .registration-status { font-size: 1.2em; font-weight: 500; margin-bottom: 15px; }
        .status-registered { color: #51CF66; }
        .status-not-registered { color: #6B7280; }
        .admin-section {
            background: #F9FAFB;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #4B5EAA;
        }
        .team-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: #FFF;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .team-table th, .team-table td {
            border: 1px solid #E2E8F0;
            padding: 12px;
            text-align: center;
            font-size: 0.9em;
        }
        .team-table th {
            background: #4B5EAA;
            color: #FFF;
            font-weight: 500;
        }
        .team-table tr:nth-child(even) { background: #F9FAFB; }
        .team-table td select {
            width: 100%;
            padding: 8px;
            border: 1px solid #E2E8F0;
            border-radius: 4px;
            background: #FFF;
        }
        .team-table td select:disabled { background: #EDF2F7; color: #6B7280; }
        .team-table.readonly td { background: #EDF2F7; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stats-card {
            background: #FFF;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #E2E8F0;
            text-align: center;
            transition: transform 0.3s ease;
        }
        .stats-card:hover { transform: translateY(-5px); }
        .stats-number { font-size: 2em; font-weight: 700; color: #4B5EAA; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #FFF;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #6B7280;
        }
        .close-modal:hover { color: #2D3748; }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            color: #4A5568;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: #FFF;
            font-weight: 500;
            z-index: 1001;
            animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s;
        }
        .notification.success { background: #51CF66; }
        .notification.error { background: #EF4444; }
        .notification.info { background: #4B5EAA; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
            .sidebar {
                transform: translateX(-250px);
                width: 200px;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            .hamburger { display: block; }
            .team-table { font-size: 0.8em; }
            .team-table th, .team-table td { padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                🛡️ 幫戰系統
            </div>
            <nav class="sidebar-nav" id="sidebarNav">
                <button onclick="showTab('home')"><span>🏠</span> 首頁</button>
                <button onclick="showTab('applications')"><span>📝</span> 申請專區</button>
                <button onclick="showTab('records')"><span>📊</span> 出勤紀錄</button>
                <button id="adminSidebarTab" onclick="showTab('admin')" style="display: none;"><span>⚙️</span> 管理員</button>
            </nav>
        </aside>
        <main class="main-content" id="mainContent">
            <div class="header">
                <button class="hamburger" onclick="toggleSidebar()">☰</button>
                <h1>幫戰報名管理系統</h1>
                <div id="userInfo" class="user-info" style="display: none;">
                    <strong id="userName"></strong> | <span id="userJob"></span>
                    <button onclick="logout()" class="btn btn-danger">登出</button>
                </div>
            </div>
            <div id="loginPage" class="tab-content active">
                <div class="login-container">
                    <h2>歡迎使用幫戰報名系統</h2>
                    <p>請使用 Discord 帳號登入</p>
                    <div class="form-group">
                        <label>測試模式：選擇用戶類型</label>
                        <select id="loginTypeSelect">
                            <option value="user">普通用戶</option>
                            <option value="admin">管理員</option>
                        </select>
                    </div>
                    <button onclick="discordLogin()" class="discord-login">🎮 使用 Discord 登入</button>
                    <div id="newUserForm" style="display: none; margin-top: 30px;">
                        <h3>首次登入設定</h3>
                        <div class="form-group">
                            <label>遊戲 ID:</label>
                            <input type="text" id="gameId" placeholder="請輸入您的遊戲 ID">
                        </div>
                        <div class="form-group">
                            <label>職業:</label>
                            <select id="jobSelect">
                                <option value="">請選擇職業</option>
                                <option value="素問">素問</option>
                                <option value="血河">血河</option>
                                <option value="九靈">九靈</option>
                                <option value="龍吟">龍吟</option>
                                <option value="碎夢">碎夢</option>
                                <option value="神相">神相</option>
                                <option value="鐵衣">鐵衣</option>
                            </select>
                        </div>
                        <button onclick="completeRegistration()" class="btn">完成註冊</button>
                    </div>
                </div>
            </div>
            <div id="mainNav" class="nav-tabs" style="display: none;"></div>
            <div id="home" class="tab-content">
                <div class="registration-card">
                    <h2>📅 幫戰報名狀態</h2>
                    <div id="registrationStatus" class="registration-status status-not-registered">目前沒有開放的幫戰報名</div>
                    <div id="registrationDate" style="font-size: 1.1em; margin-bottom: 10px;"></div>
                    <div id="registrationDeadline" style="font-size: 1em; margin-bottom: 10px;"></div>
                    <div id="teamAssignment" style="font-size: 1em; margin-bottom: 10px;"></div>
                    <div id="registrationActions">
                        <button id="registerBtn" onclick="registerForBattle()" class="btn" style="display: none;">報名參戰</button>
                        <button id="cancelBtn" onclick="cancelRegistration()" class="btn btn-danger" style="display: none;">取消報名</button>
                        <div id="deadlineMessage" style="color: #EF4444; margin-top: 10px; display: none;">如需更動，請聯繫指揮</div>
                    </div>
                </div>
                <div id="battleFormation" style="display: none;">
                    <h3>📋 出戰表</h3>
                    <div id="formationDisplay"></div>
                </div>
            </div>
            <div id="applications" class="tab-content">
                <div class="admin-section">
                    <h3>🔄 更換職業申請</h3>
                    <div class="form-group">
                        <label>新職業:</label>
                        <select id="newJobSelect">
                            <option value="">請選擇新職業</option>
                            <option value="素問">素問</option>
                            <option value="血河">血河</option>
                            <option value="九靈">九靈</option>
                            <option value="龍吟">龍吟</option>
                            <option value="碎夢">碎夢</option>
                            <option value="神相">神相</option>
                            <option value="鐵衣">鐵衣</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>申請理由:</label>
                        <textarea id="jobChangeReason" placeholder="請說明更換職業的原因" rows="3"></textarea>
                    </div>
                    <button onclick="submitJobChange()" class="btn">提交申請</button>
                </div>
                <div class="admin-section">
                    <h3>👥 代報名系統</h3>
                    <div class="form-group">
                        <label>代報名 ID:</label>
                        <input type="text" id="proxyId" placeholder="請輸入要代報名的遊戲 ID">
                    </div>
                    <div class="form-group">
                        <label>代報名原因:</label>
                        <textarea id="proxyReason" placeholder="請說明代報名的原因" rows="3"></textarea>
                    </div>
                    <button onclick="submitProxyRegistration()" class="btn">提交代報名</button>
                </div>
                <div class="admin-section">
                    <h3>🏥 請假申請</h3>
                    <div class="form-group">
                        <label>請假日期:</label>
                        <input type="date" id="leaveDate">
                    </div>
                    <div class="form-group">
                        <label>請假原因（可空白）:</label>
                        <textarea id="leaveReason" placeholder="請說明請假原因" rows="3"></textarea>
                    </div>
                    <button id="leaveSubmitBtn" onclick="submitLeaveRequest()" class="btn">提交請假申請</button>
                    <div id="leaveDeadlineMessage" style="color: #EF4444; margin-top: 10px; display: none;">如需請假，請聯繫指揮</div>
                </div>
            </div>
            <div id="records" class="tab-content">
                <h2>📊 我的出勤紀錄</h2>
                <div class="stats-grid">
                    <div class="stats-card">
                        <div class="stats-number" id="attendanceRate">0%</div>
                        <div>出勤率</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="totalBattles">0</div>
                        <div>總參戰次數</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="absenceCount">0</div>
                        <div>缺席次數</div>
                    </div>
                </div>
                <div id="recordsList"></div>
            </div>
            <div id="admin" class="tab-content">
                <div class="admin-section">
                    <h3>📅 開放報名日期</h3>
                    <div class="form-group">
                        <label>幫戰日期:</label>
                        <input type="date" id="battleDate">
                    </div>
                    <div class="form-group">
                        <label>幫戰時間:</label>
                        <select id="battleTime">
                        <option value="14:00">14:00</option>
                        <option value="20:00">20:00</option>
                    </select>
                    </div>
                    <div class="form-group">
                        <label>報名截止日期:</label>
                        <input type="date" id="deadlineDate">
                    </div>
                    <div class="form-group">
                        <label>報名截止時間:</label>
                        <select id="deadlineTime">
                            <option value="12:00">12:00</option>
                            <option value="18:00">18:00</option>
                            <option value="20:00">20:00</option>
                            <option value="23:59">23:59</option>
                        </select>
                    </div>
                    <button onclick="openRegistration()" class="btn">開放報名</button>
                    <button onclick="closeRegistration()" class="btn btn-danger">關閉報名</button>
                </div>
                <div class="admin-section">
                    <h3>👥 成員管理</h3>
                    <div class="job-button-group" id="jobButtonGroup"></div>
                </div>
                <div class="admin-section">
                    <h3>⚔️ 出戰表部署</h3>
                    <div class="form-group">
                        <button onclick="showFormationEditor('edit')" class="btn">編輯出戰表</button>
                        <button onclick="publishFormation()" class="btn btn-success">發佈出戰表</button>
                        <button onclick="showFormationEditor('confirm')" class="btn btn-success">確認最終出戰表</button>
                    </div>
                    <div id="formationEditor" style="display: none;">
                        <div class="battle-formation" id="battleFormationContainer"></div>
                        <div id="formationActions" style="text-align: center; margin-top: 20px;">
                            <button id="confirmFormationBtn" onclick="confirmFinalFormation()" class="btn btn-success" style="display: none;">確認最終出戰表</button>
                        </div>
                    </div>
                </div>
                <div class="admin-section">
                    <h3>📊 統計報表</h3>
                    <div class="stats-grid">
                        <div class="stats-card">
                            <div class="stats-number" id="totalMembers">0</div>
                            <div>總成員數</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-number" id="registeredCount">0</div>
                            <div>已報名人數</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-number" id="onLeaveCount">0</div>
                            <div>請假人數</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">×</button>
            <div id="modalContent"></div>
        </div>
    </div>
    <script>
        let currentUser = null;
        let isLoggedIn = false;
        let currentBattle = null;
        let battles = [];
        let members = [];
        let battleFormation = [];
        let registrations = [];
        let leaveRequests = [];
        let attendanceRecords = [];
        let assignedPlayers = new Set();
        const initialMembers = [
            { id: 'player001', discordId: 'admin_user1', name: '勇者', job: '素問', isAdmin: true, onLeave: false },
            { id: 'player002', discordId: 'user2', name: '法師', job: '血河', isAdmin: false, onLeave: false },
            { id: 'player003', discordId: 'user3', name: '弓手', job: '九靈', isAdmin: false, onLeave: false },
            { id: 'player004', discordId: 'user4', name: '牧師', job: '龍吟', isAdmin: false, onLeave: false },
            { id: 'player005', discordId: 'user5', name: '盜賊', job: '碎夢', isAdmin: false, onLeave: false },
            { id: 'player006', discordId: 'user6', name: '騎士', job: '神相', isAdmin: false, onLeave: false },
            { id: 'player007', discordId: 'user7', name: '戰士', job: '鐵衣', isAdmin: false, onLeave: false }
        ];
        const jobs = ['素問', '血河', '九靈', '龍吟', '碎夢', '神相', '鐵衣'];
        const teamNames = ['進攻隊', '防守隊', '機動隊', '空拆隊', '拆塔隊'];
        function initSystem() {
            members = [...initialMembers];
            updateJobButtonGroup();
            updateStats();
        }
        function discordLogin() {
            showNotification('正在連接 Discord...', 'info');
            setTimeout(() => {
                const loginType = document.getElementById('loginTypeSelect').value;
                let mockDiscordUser;
                if (loginType === 'admin') {
                    mockDiscordUser = { id: 'admin_user1', username: 'AdminUser', avatar: null };
                } else {
                    mockDiscordUser = { id: 'discord_' + Math.random().toString(36).substr(2, 9), username: 'TestUser' + Math.floor(Math.random() * 1000), avatar: null };
                }
                const existingUser = members.find(m => m.discordId === mockDiscordUser.id);
                if (existingUser) {
                    currentUser = existingUser;
                    completeLogin();
                } else {
                    showNotification('Discord 授權成功！請完成首次設定', 'success');
                    document.getElementById('newUserForm').style.display = 'block';
                    currentUser = { discordId: mockDiscordUser.id, discordUsername: mockDiscordUser.username };
                }
            }, 2000);
        }
        function completeRegistration() {
            const gameId = document.getElementById('gameId').value.trim();
            const job = document.getElementById('jobSelect').value;
            const loginType = document.getElementById('loginTypeSelect').value;
            if (!gameId || !job) {
                showNotification('請填寫所有必要資訊', 'error');
                return;
            }
            if (members.find(m => m.id === gameId)) {
                showNotification('此遊戲 ID 已存在', 'error');
                return;
            }
            const newUser = {
                id: gameId,
                discordId: currentUser.discordId,
                name: gameId,
                job: job,
                isAdmin: loginType === 'admin',
                onLeave: false
            };
            members.push(newUser);
            currentUser = newUser;
            showNotification('註冊成功！', 'success');
            completeLogin();
        }
        function completeLogin() {
            isLoggedIn = true;
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainNav').style.display = 'none';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userJob').textContent = currentUser.job;
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('mainContent').classList.remove('full');
            if (currentUser.isAdmin) {
                document.getElementById('adminSidebarTab').style.display = 'block';
            }
            showTab('home');
            updateUserInterface();
        }
        function logout() {
            currentUser = null;
            isLoggedIn = false;
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('mainNav').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('adminSidebarTab').style.display = 'none';
            document.getElementById('newUserForm').style.display = 'none';
            document.getElementById('gameId').value = '';
            document.getElementById('jobSelect').value = '';
            document.getElementById('loginTypeSelect').value = 'user';
            document.getElementById('mainContent').classList.add('full');
            showNotification('已成功登出', 'info');
        }
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            const sidebarButtons = document.querySelectorAll('.sidebar-nav button');
            sidebarButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            const activeBtn = document.querySelector(`.sidebar-nav button[onclick="showTab('${tabName}')"]`);
            if (activeBtn) activeBtn.classList.add('active');
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
            }
            switch (tabName) {
                case 'home': updateHomeContent(); break;
                case 'records': updateRecordsContent(); break;
                case 'admin': updateAdminContent(); break;
            }
        }
        function updateUserInterface() {
            updateHomeContent();
            updateJobButtonGroup();
            updateStats();
        }
        function isPastDeadline(battle) {
            if (!battle.deadlineDate || !battle.deadlineTime) return false;
            const deadline = new Date(`${battle.deadlineDate}T${battle.deadlineTime}:00`);
            return new Date() > deadline;
        }
        function updateHomeContent() {
            const statusDiv = document.getElementById('registrationStatus');
            const dateDiv = document.getElementById('registrationDate');
            const deadlineDiv = document.getElementById('registrationDeadline');
            const teamAssignmentDiv = document.getElementById('teamAssignment');
            const registerBtn = document.getElementById('registerBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const deadlineMessage = document.getElementById('deadlineMessage');
            if (currentBattle) {
                const userRegistered = registrations.find(r => r.userId === currentUser.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time);
                if (userRegistered) {
                    statusDiv.textContent = `✅ ${currentBattle.date} ${currentBattle.time} 已報名${userRegistered.isBackup ? '（備選名單）' : ''}`;
                    statusDiv.className = 'registration-status status-registered';
                    registerBtn.style.display = 'none';
                    cancelBtn.style.display = isPastDeadline(currentBattle) ? 'none' : 'inline-block';
                } else {
                    statusDiv.textContent = `📢 ${currentBattle.date} ${currentBattle.time} 開放報名中`;
                    statusDiv.className = 'registration-status status-not-registered';
                    registerBtn.style.display = 'inline-block';
                    cancelBtn.style.display = 'none';
                }
                dateDiv.textContent = `幫戰時間: ${currentBattle.date} ${currentBattle.time}`;
                deadlineDiv.textContent = currentBattle.deadlineDate ? `報名截止: ${currentBattle.deadlineDate} ${currentBattle.deadlineTime}` : '';
                if (currentBattle.formationPublished && currentBattle.formation) {
                    let assignedTeam = null;
                    currentBattle.formation.forEach((group, groupIndex) => {
                        group.forEach(team => {
                            if (team.slots.some(slot => slot.playerId === currentUser.id)) {
                                assignedTeam = `您被分配到第${groupIndex + 1}團 ${team.team}`;
                            }
                        });
                    });
                    teamAssignmentDiv.textContent = assignedTeam || '您尚未被分配到任何小隊';
                } else {
                    teamAssignmentDiv.textContent = '';
                }
                deadlineMessage.style.display = isPastDeadline(currentBattle) ? 'block' : 'none';
                document.getElementById('leaveDeadlineMessage').style.display = isPastDeadline(currentBattle) ? 'block' : 'none';
                document.getElementById('leaveSubmitBtn').style.display = isPastDeadline(currentBattle) ? 'none' : 'inline-block';
            } else {
                statusDiv.textContent = '目前沒有開放的幫戰報名';
                statusDiv.className = 'registration-status status-not-registered';
                dateDiv.textContent = '';
                deadlineDiv.textContent = '';
                teamAssignmentDiv.textContent = '';
                registerBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
                deadlineMessage.style.display = 'none';
                document.getElementById('leaveDeadlineMessage').style.display = 'none';
                document.getElementById('leaveSubmitBtn').style.display = 'inline-block';
            }
            if (currentBattle && currentBattle.formationPublished) {
                document.getElementById('battleFormation').style.display = 'block';
                displayFormation();
            } else {
                document.getElementById('battleFormation').style.display = 'none';
            }
        }
        function registerForBattle() {
            if (!currentBattle) {
                showNotification('目前沒有開放的幫戰報名', 'error');
                return;
            }
            const existingRegistration = registrations.find(r => r.userId === currentUser.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time);
            if (existingRegistration) {
                showNotification('您已經報名此次幫戰', 'error');
                return;
            }
            const onLeave = leaveRequests.find(r => r.userId === currentUser.id && r.date === currentBattle.date && r.approved);
            if (onLeave) {
                showNotification('您在此日期已請假，無法報名', 'error');
                return;
            }
            const isBackup = isPastDeadline(currentBattle);
            registrations.push({
                userId: currentUser.id,
                userName: currentUser.name,
                userJob: currentUser.job,
                battleDate: currentBattle.date,
                battleTime: currentBattle.time,
                registrationTime: new Date().toISOString(),
                isBackup: isBackup
            });
            showNotification(isBackup ? '已超過報名時間，系統自動幫您排入備選名單' : '報名成功！', 'success');
            updateHomeContent();
            updateStats();
            updateJobButtonGroup();
        }
        function cancelRegistration() {
            if (!currentBattle) return;
            if (isPastDeadline(currentBattle)) {
                showNotification('已超過報名截止時間，請聯繫指揮', 'error');
                return;
            }
            const index = registrations.findIndex(r => r.userId === currentUser.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time);
            if (index !== -1) {
                registrations.splice(index, 1);
                showNotification('已取消報名', 'info');
                updateHomeContent();
                updateStats();
                updateJobButtonGroup();
            }
        }
        function submitJobChange() {
            const newJob = document.getElementById('newJobSelect').value;
            const reason = document.getElementById('jobChangeReason').value.trim();
            if (!newJob || !reason) {
                showNotification('請填寫所有欄位', 'error');
                return;
            }
            if (newJob === currentUser.job) {
                showNotification('新職業與目前職業相同', 'error');
                return;
            }
            if (currentUser.isAdmin) {
                currentUser.job = newJob;
                const memberIndex = members.findIndex(m => m.id === currentUser.id);
                if (memberIndex !== -1) {
                    members[memberIndex].job = newJob;
                }
                document.getElementById('userJob').textContent = newJob;
                showNotification('職業更換成功！', 'success');
            } else {
                showNotification('職業更換申請已提交，等待管理員審核', 'info');
            }
            document.getElementById('newJobSelect').value = '';
            document.getElementById('jobChangeReason').value = '';
            updateJobButtonGroup();
        }
        function submitProxyRegistration() {
            const proxyId = document.getElementById('proxyId').value.trim();
            const reason = document.getElementById('proxyReason').value.trim();
            if (!proxyId || !reason) {
                showNotification('請填寫所有欄位', 'error');
                return;
            }
            if (!currentBattle) {
                showNotification('目前沒有開放的幫戰報名', 'error');
                return;
            }
            const targetUser = members.find(m => m.id === proxyId);
            if (!targetUser) {
                showNotification('找不到該遊戲 ID', 'error');
                return;
            }
            const existingRegistration = registrations.find(r => r.userId === proxyId && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time);
            if (existingRegistration) {
                showNotification('該用戶已經報名此次幫戰', 'error');
                return;
            }
            const isBackup = isPastDeadline(currentBattle);
            registrations.push({
                userId: proxyId,
                userName: targetUser.name,
                userJob: targetUser.job,
                battleDate: currentBattle.date,
                battleTime: currentBattle.time,
                registrationTime: new Date().toISOString(),
                proxyBy: currentUser.id,
                proxyReason: reason,
                isBackup: isBackup
            });
            showNotification(`已成功為 ${targetUser.name} 代報名${isBackup ? '（備選名單）' : ''}`, 'success');
            document.getElementById('proxyId').value = '';
            document.getElementById('proxyReason').value = '';
            updateStats();
            updateJobButtonGroup();
        }
        function submitLeaveRequest() {
            const leaveDate = document.getElementById('leaveDate').value;
            const reason = document.getElementById('leaveReason').value.trim();
            if (!leaveDate || !reason) {
                showNotification('請填寫所有欄位', 'error');
                return;
            }
            const battle = battles.find(b => b.date === leaveDate);
            if (battle && isPastDeadline(battle)) {
                showNotification('已超過報名截止時間，請聯繫指揮', 'error');
                return;
            }
            const existingLeave = leaveRequests.find(r => r.userId === currentUser.id && r.date === leaveDate);
            if (existingLeave) {
                showNotification('您在此日期已有請假記錄', 'error');
                return;
            }
            leaveRequests.push({
                userId: currentUser.id,
                userName: currentUser.name,
                date: leaveDate,
                reason: reason,
                approved: currentUser.isAdmin,
                submitTime: new Date().toISOString()
            });
            if (currentUser.isAdmin) {
                const memberIndex = members.findIndex(m => m.id === currentUser.id);
                if (memberIndex !== -1 && leaveDate === (currentBattle?.date)) {
                    members[memberIndex].onLeave = true;
                }
                showNotification('請假申請已批准', 'success');
            } else {
                showNotification('請假申請已提交，等待管理員審核', 'info');
            }
            document.getElementById('leaveDate').value = '';
            document.getElementById('leaveReason').value = '';
            updateJobButtonGroup();
        }
        function updateRecordsContent() {
            const userRecords = attendanceRecords.filter(r => r.userId === currentUser.id);
            const totalBattles = userRecords.length;
            const attendedBattles = userRecords.filter(r => r.attended).length;
            const attendanceRate = totalBattles > 0 ? Math.round((attendedBattles / totalBattles) * 100) : 0;
            document.getElementById('attendanceRate').textContent = attendanceRate + '%';
            document.getElementById('totalBattles').textContent = attendedBattles;
            document.getElementById('absenceCount').textContent = totalBattles - attendedBattles;
            let recordsHtml = '<h3>近期出勤記錄</h3>';
            if (userRecords.length === 0) {
                recordsHtml += '<p>暫無出勤記錄</p>';
            } else {
                recordsHtml += '<div class="records-list">';
                userRecords.slice(-10).reverse().forEach(record => {
                    const statusClass = record.attended ? 'status-registered' : 'status-not-registered';
                    const statusText = record.attended ? '✅ 出席' : '❌ 缺席';
                    recordsHtml += `
                        <div class="admin-section">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${record.battleDate} ${record.battleTime}</strong> - ${record.group ? `第${record.group}團 ` : ''}${record.team || '未分配'}
                                </div>
                                <div class="${statusClass}">${statusText}</div>
                            </div>
                        </div>
                    `;
                });
                recordsHtml += '</div>';
            }
            document.getElementById('recordsList').innerHTML = recordsHtml;
        }
        function updateAdminContent() {
            if (!currentUser?.isAdmin) return;
            updateJobButtonGroup();
            updateStats();
        }
        function checkUnconfirmedBattles(newBattleDate) {
            return battles.filter(b => !b.confirmed && b.date !== newBattleDate);
        }
        function openRegistration() {
            const battleDate = document.getElementById('battleDate').value;
            const battleTime = document.getElementById('battleTime').value;
            const deadlineDate = document.getElementById('deadlineDate').value;
            const deadlineTime = document.getElementById('deadlineTime').value;
            if (!battleDate || !battleTime || !deadlineDate || !deadlineTime) {
                showNotification('請填寫所有必要欄位', 'error');
                return;
            }
            const deadline = new Date(`${deadlineDate}T${deadlineTime}:00`);
            const battle = new Date(`${battleDate}T${battleTime}:00`);
            if (deadline >= battle) {
                showNotification('報名截止時間必須早於幫戰時間', 'error');
                return;
            }
            const unconfirmedBattles = checkUnconfirmedBattles(battleDate);
            if (unconfirmedBattles.length > 0) {
                const modalContent = `
                    <h3>提醒：未確認的場次</h3>
                    <p>以下場次尚未確認最終出戰表：</p>
                    <ul>
                        ${unconfirmedBattles.map(b => `<li>${b.date} ${b.time}</li>`).join('')}
                    </ul>
                    <p>是否繼續開放新場次？</p>
                    <div style="margin-top: 20px;">
                        <button onclick="showTab('admin'); showFormationEditor('confirm'); closeModal();" class="btn">前往確認</button>
                        <button onclick="proceedOpenRegistration('${battleDate}', '${battleTime}', '${deadlineDate}', '${deadlineTime}'); closeModal();" class="btn btn-success">繼續開放</button>
                    </div>
                `;
                showModal(modalContent);
            } else {
                proceedOpenRegistration(battleDate, battleTime, deadlineDate, deadlineTime);
            }
        }
        function proceedOpenRegistration(battleDate, battleTime, deadlineDate, deadlineTime) {
            currentBattle = {
                date: battleDate,
                time: battleTime,
                deadlineDate: deadlineDate,
                deadlineTime: deadlineTime,
                open: true,
                formationPublished: false,
                formation: [],
                confirmed: false
            };
            battles.push(currentBattle);
            battleFormation = [];
            assignedPlayers.clear();
            showNotification(`已開放 ${battleDate} ${battleTime} 的報名`, 'success');
            updateHomeContent();
            updateStats();
            document.getElementById('battleDate').value = '';
            document.getElementById('battleTime').value = '';
            document.getElementById('deadlineDate').value = '';
            document.getElementById('deadlineTime').value = '';
        }
        function closeRegistration() {
            if (!currentBattle) {
                showNotification('目前沒有開放的報名', 'error');
                return;
            }
            currentBattle.open = false;
            showNotification('已關閉當前報名', 'success');
            updateHomeContent();
        }
        function updateJobButtonGroup() {
            const container = document.getElementById('jobButtonGroup');
            if (!container) return;
            let html = '';
            jobs.forEach(job => {
                const registeredMembers = registrations
                    .filter(r => r.battleDate === currentBattle?.date && r.battleTime === currentBattle?.time)
                    .map(r => members.find(m => m.id === r.userId))
                    .filter(m => m && m.job === job);
                html += `
                    <div>
                        <button class="job-button" onclick="toggleJobMembers('job-${job}')">${job} (${registeredMembers.length})</button>
                        <div id="job-${job}" class="job-members">
                            ${registeredMembers.length ? registeredMembers.map(m => `
                                <span class="member-id" onclick="selectMember('${m.id}')">${m.id}${m.onLeave ? ' (請假)' : ''}</span>
                            `).join('') : '<span style="font-size: 0.8em; color: #999;">無報名成員</span>'}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        function toggleJobMembers(jobId) {
            const element = document.getElementById(jobId);
            const isActive = element.classList.contains('active');
            document.querySelectorAll('.job-members').forEach(el => el.classList.remove('active'));
            if (!isActive) {
                element.classList.add('active');
            }
        }
        function selectMember(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            const modalContent = `
                <h3>成員資訊: ${member.name}</h3>
                <p><strong>ID:</strong> ${member.id}</p>
                <p><strong>職業:</strong> ${member.job}</p>
                <p><strong>Discord:</strong> ${member.discordId}</p>
                <p><strong>狀態:</strong> ${member.onLeave ? '請假中' : '正常'}</p>
                <p><strong>權限:</strong> ${member.isAdmin ? '管理員' : '一般成員'}</p>
                <div style="margin-top: 20px;">
                    <button onclick="toggleMemberLeave('${member.id}')" class="btn">${member.onLeave ? '解除請假' : '設為請假'}</button>
                    <button onclick="deleteMember('${member.id}')" class="btn btn-danger">刪除成員</button>
                </div>
            `;
            showModal(modalContent);
        }
        function toggleMemberLeave(memberId) {
            const memberIndex = members.findIndex(m => m.id === memberId);
            if (memberIndex !== -1) {
                members[memberIndex].onLeave = !members[memberIndex].onLeave;
                updateJobButtonGroup();
                closeModal();
                showNotification('已更新成員狀態', 'success');
            }
        }
        function deleteMember(memberId) {
            if (memberId === currentUser.id) {
                showNotification('不能刪除自己的帳號', 'error');
                return;
            }
            const memberIndex = members.findIndex(m => m.id === memberId);
            if (memberIndex !== -1) {
                members.splice(memberIndex, 1);
                updateJobButtonGroup();
                updateStats();
                closeModal();
                showNotification('已刪除成員', 'success');
            }
        }
        function showFormationEditor(mode = 'edit') {
            if (!currentBattle) {
                showNotification('請先開放報名', 'error');
                return;
            }
            const editor = document.getElementById('formationEditor');
            const confirmBtn = document.getElementById('confirmFormationBtn');
            if (!editor || !confirmBtn) {
                showNotification('頁面元素載入失敗，請刷新頁面', 'error');
                return;
            }
            editor.style.display = 'block';
            confirmBtn.style.display = mode === 'confirm' ? 'inline-block' : 'none';
            assignedPlayers.clear();
            battleFormation.forEach(group => {
                group.forEach(team => {
                    team.slots.forEach(slot => {
                        if (slot.playerId) assignedPlayers.add(slot.playerId);
                    });
                });
            });
            generateFormation(mode);
        }
        function generateFormation(mode) {
            const container = document.getElementById('battleFormationContainer');
            if (!container) {
                showNotification('出戰表容器未找到', 'error');
                return;
            }
            if (currentBattle.formationPublished && currentBattle.formation.length) {
                battleFormation = JSON.parse(JSON.stringify(currentBattle.formation));
            } else if (!battleFormation.length) {
                battleFormation = Array(2).fill().map(() =>
                    Array(5).fill().map(() => ({
                        team: '',
                        slots: Array(6).fill().map(() => ({ job: '', playerId: '' }))
                    }))
                );
            }
            let html = '';
            battleFormation.forEach((group, groupIndex) => {
                html += `<h4>第${groupIndex + 1}團</h4>`;
                html += `<table class="team-table">`;
                html += `<thead><tr>`;
                for (let teamIdx = 0; teamIdx < 5; teamIdx++) {
                    const teamSelectId = `team_${groupIndex}_${teamIdx}`;
                    const isDisabled = mode === 'confirm' && battleFormation[groupIndex][teamIdx].team ? 'disabled' : '';
                    html += `
                        <th colspan="2">
                            <select id="${teamSelectId}" onchange="updateTeamName(${groupIndex}, ${teamIdx})" ${isDisabled}>
                                <option value="">選擇小隊</option>
                                ${teamNames.map(name => `
                                    <option value="${name}" ${battleFormation[groupIndex][teamIdx].team === name ? 'selected' : ''}>${name}</option>
                                `).join('')}
                            </select>
                        </th>
                    `;
                }
                html += `</tr></thead>`;
                html += `<tbody>`;
                for (let row = 0; row < 6; row++) {
                    html += `<tr>`;
                    for (let teamIdx = 0; teamIdx < 5; teamIdx++) {
                        const jobSelectId = `job_${groupIndex}_${teamIdx}_${row}`;
                        const playerSelectId = `player_${groupIndex}_${teamIdx}_${row}`;
                        const slot = battleFormation[groupIndex][teamIdx].slots[row] || { job: '', playerId: '' };
                        html += `
                            <td>
                                <select id="${jobSelectId}" onchange="updateFormationCell('${jobSelectId}', '${playerSelectId}', ${groupIndex}, ${teamIdx}, ${row})">
                                    <option value="">選擇職業</option>
                                    ${jobs.map(job => `<option value="${job}" ${slot.job === job ? 'selected' : ''}>${job}</option>`).join('')}
                                </select>
                            </td>
                            <td>
                                <select id="${playerSelectId}" ${slot.job ? '' : 'disabled'} onchange="updatePlayerSelection('${playerSelectId}', ${groupIndex}, ${teamIdx}, ${row})">
                                    <option value="">選擇玩家</option>
                                    ${slot.job ? members
                                        .filter(m => m.job === slot.job && !m.onLeave && registrations.some(r => r.userId === m.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time) && !assignedPlayers.has(m.id))
                                        .map(m => `<option value="${m.id}" ${slot.playerId === m.id ? 'selected' : ''}>${m.name}</option>`).join('') : ''}
                                </select>
                            </td>
                        `;
                    }
                    html += `</tr>`;
                }
                html += `</tbody></table>`;
            });
            container.innerHTML = html;
        }
        function updateTeamName(groupIndex, teamIndex) {
            const select = document.getElementById(`team_${groupIndex}_${teamIndex}`);
            if (select) {
                battleFormation[groupIndex][teamIndex].team = select.value;
            }
        }
        function updateFormationCell(jobSelectId, playerSelectId, groupIndex, teamIndex, slotIndex) {
            const jobSelect = document.getElementById(jobSelectId);
            const playerSelect = document.getElementById(playerSelectId);
            if (!jobSelect || !playerSelect) return;
            const previousPlayerId = battleFormation[groupIndex][teamIndex].slots[slotIndex].playerId;
            if (previousPlayerId) {
                assignedPlayers.delete(previousPlayerId);
            }
            const selectedJob = jobSelect.value;
            battleFormation[groupIndex][teamIndex].slots[slotIndex].job = selectedJob;
            battleFormation[groupIndex][teamIndex].slots[slotIndex].playerId = '';
            if (selectedJob) {
                const availablePlayers = members
                    .filter(m => m.job === selectedJob && !m.onLeave && registrations.some(r => r.userId === m.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time) && !assignedPlayers.has(m.id));
                let options = '<option value="">選擇玩家</option>';
                availablePlayers.forEach(player => {
                    options += `<option value="${player.id}">${player.name}</option>`;
                });
                playerSelect.innerHTML = options;
                playerSelect.disabled = false;
            } else {
                playerSelect.innerHTML = '<option value="">選擇玩家</option>';
                playerSelect.disabled = true;
            }
            updateAllPlayerSelects();
        }
        function updatePlayerSelection(playerSelectId, groupIndex, teamIndex, slotIndex) {
            const playerSelect = document.getElementById(playerSelectId);
            if (!playerSelect) return;
            const previousPlayerId = battleFormation[groupIndex][teamIndex].slots[slotIndex].playerId;
            if (previousPlayerId) {
                assignedPlayers.delete(previousPlayerId);
            }
            const selectedPlayerId = playerSelect.value;
            battleFormation[groupIndex][teamIndex].slots[slotIndex].playerId = selectedPlayerId;
            if (selectedPlayerId) {
                assignedPlayers.add(selectedPlayerId);
            }
            updateAllPlayerSelects();
        }
        function updateAllPlayerSelects() {
            battleFormation.forEach((group, groupIndex) => {
                group.forEach((team, teamIndex) => {
                    team.slots.forEach((slot, slotIndex) => {
                        const playerSelectId = `player_${groupIndex}_${teamIndex}_${slotIndex}`;
                        const playerSelect = document.getElementById(playerSelectId);
                        if (playerSelect && slot.job) {
                            const currentValue = playerSelect.value;
                            const availablePlayers = members
                                .filter(m => m.job === slot.job && !m.onLeave && registrations.some(r => r.userId === m.id && r.battleDate === currentBattle.date && r.battleTime === currentBattle.time) && (!assignedPlayers.has(m.id) || m.id === currentValue));
                            let options = '<option value="">選擇玩家</option>';
                            availablePlayers.forEach(player => {
                                options += `<option value="${player.id}" ${player.id === currentValue ? 'selected' : ''}>${player.name}</option>`;
                            });
                            playerSelect.innerHTML = options;
                        }
                    });
                });
            });
        }
        function publishFormation() {
            if (!currentBattle) {
                showNotification('請先開放報名', 'error');
                return;
            }
            let hasEmptyTeam = false;
            battleFormation.forEach(group => {
                group.forEach(team => {
                    if (team.slots.some(slot => slot.job || slot.playerId) && !team.team) {
                        hasEmptyTeam = true;
                    }
                });
            });
            if (hasEmptyTeam) {
                showNotification('請為所有有分配的小隊選擇名稱', 'error');
                return;
            }
            const assignedPlayersCheck = new Set();
            let hasDuplicates = false;
            battleFormation.forEach(group => {
                group.forEach(team => {
                    team.slots.forEach(slot => {
                        if (slot.playerId && assignedPlayersCheck.has(slot.playerId)) {
                            hasDuplicates = true;
                        } else if (slot.playerId) {
                            assignedPlayersCheck.add(slot.playerId);
                        }
                    });
                });
            });
            if (hasDuplicates) {
                showNotification('出戰表中存在重複分配的玩家，請檢查後重新發佈', 'error');
                return;
            }
            currentBattle.formation = JSON.parse(JSON.stringify(battleFormation));
            currentBattle.formationPublished = true;
            showNotification('出戰表已發佈！已通知所有參戰成員', 'success');
            document.getElementById('formationEditor').style.display = 'none';
            updateHomeContent();
        }
        function confirmFinalFormation() {
            if (!currentBattle || !currentBattle.formationPublished) {
                showNotification('請先發佈出戰表', 'error');
                return;
            }
            let hasEmptyTeam = false;
            battleFormation.forEach(group => {
                group.forEach(team => {
                    if (team.slots.some(slot => slot.job || slot.playerId) && !team.team) {
                        hasEmptyTeam = true;
                    }
                });
            });
            if (hasEmptyTeam) {
                showNotification('請為所有有分配的小隊選擇名稱', 'error');
                return;
            }
            const assignedPlayersCheck = new Set();
            let hasDuplicates = false;
            battleFormation.forEach(group => {
                group.forEach(team => {
                    team.slots.forEach(slot => {
                        if (slot.playerId && assignedPlayersCheck.has(slot.playerId)) {
                            hasDuplicates = true;
                        } else if (slot.playerId) {
                            assignedPlayersCheck.add(slot.playerId);
                        }
                    });
                });
            });
            if (hasDuplicates) {
                showNotification('出戰表中存在重複分配的玩家，請檢查後重新確認', 'error');
                return;
            }
            currentBattle.formation = JSON.parse(JSON.stringify(battleFormation));
            const battleRegistrations = registrations.filter(r => r.battleDate === currentBattle.date && r.battleTime === currentBattle.time && !r.isBackup);
            battleRegistrations.forEach(reg => {
                let playerGroup = null;
                let playerTeam = null;
                currentBattle.formation.forEach((group, groupIndex) => {
                    group.forEach(team => {
                        if (team.slots.some(slot => slot.playerId === reg.userId)) {
                            playerGroup = groupIndex + 1;
                            playerTeam = team.team;
                        }
                    });
                });
                attendanceRecords.push({
                    userId: reg.userId,
                    userName: reg.userName,
                    battleDate: currentBattle.date,
                    battleTime: currentBattle.time,
                    attended: true,
                    group: playerGroup,
                    team: playerTeam || '未分配'
                });
            });
            currentBattle.confirmed = true;
            showNotification('已確認最終出戰表，出勤記錄已生成', 'success');
            document.getElementById('formationEditor').style.display = 'none';
            updateRecordsContent();
            updateHomeContent();
        }
        function displayFormation() {
            const container = document.getElementById('formationDisplay');
            if (!container || !currentBattle.formation) return;
            let html = '';
            currentBattle.formation.forEach((group, groupIndex) => {
                html += `<h4>第${groupIndex + 1}團</h4>`;
                group.forEach(team => {
                    const filledSlots = team.slots.filter(slot => slot.job && slot.playerId);
                    if (filledSlots.length === 0 || !team.team) return;
                    html += `
                        <div class="battle-formation">
                            <h5>${team.team}</h5>
                            <table class="team-table readonly">
                                <thead><tr><th>職業</th><th>玩家</th></tr></thead>
                                <tbody>
                    `;
                    filledSlots.forEach(slot => {
                        const player = members.find(m => m.id === slot.playerId);
                        html += `
                            <tr>
                                <td>${slot.job}</td>
                                <td>${player ? player.name : '-'}</td>
                            </tr>
                        `;
                    });
                    html += `</tbody></table></div>`;
                });
            });
            container.innerHTML = html || '<p>出戰表尚未分配任何成員</p>';
        }
        function updateStats() {
            const totalMembersEl = document.getElementById('totalMembers');
            if (totalMembersEl) totalMembersEl.textContent = members.length;
            const registeredCountEl = document.getElementById('registeredCount');
            if (registeredCountEl && currentBattle) {
                const count = registrations.filter(r => r.battleDate === currentBattle.date && r.battleTime === currentBattle.time).length;
                registeredCountEl.textContent = count;
            }
            const onLeaveCountEl = document.getElementById('onLeaveCount');
            if (onLeaveCountEl) onLeaveCountEl.textContent = members.filter(m => m.onLeave).length;
        }
        function showModal(content) {
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
        document.getElementById('modal').addEventListener('click', function (e) {
            if (e.target === this) closeModal();
        });
        document.addEventListener('DOMContentLoaded', initSystem);
    </script>
</body>
</html>
